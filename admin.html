<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Admin Console | easyresults</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020617">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="security.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
    <script src="utils.js"></script>

    <style>
        :root { --bg-dark: #020617; --bg-panel: rgba(15, 23, 42, 0.95); --bg-input: rgba(30, 41, 59, 0.6); --primary: #6366f1;  --primary-glow: rgba(99, 102, 241, 0.5); --text-main: #f8fafc; --text-muted: #94a3b8; --border: rgba(255,255,255,0.08); --safe-bottom: env(safe-area-inset-bottom); }
        .text-main { color: var(--text-main) !important; } .text-muted { color: var(--text-muted) !important; } .bg-dark { background-color: var(--bg-dark) !important; } .bg-panel { background-color: var(--bg-panel) !important; } .border-theme { border-color: var(--border) !important; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); background-image: radial-gradient(at 0% 0%, var(--primary-glow) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%); background-attachment: fixed; transition: background-color 0.5s ease, color 0.5s ease; overflow: hidden; }
        .glass-panel { background: var(--bg-panel); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); transition: background 0.5s ease, border-color 0.5s ease; }
        .input-field { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 12px 16px; border-radius: 10px; width: 100%; outline: none; transition: all 0.2s ease; font-size: 0.95rem; min-height: 44px; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
        .input-field:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #4338ca); color: white !important; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 15px -3px var(--primary-glow); display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; min-height: 44px; }
        .btn-primary:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .btn-secondary { background: rgba(125,125,125,0.1); color: var(--text-main); border: 1px solid var(--border); padding: 10px 16px; border-radius: 10px; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; min-height: 44px; }
        .btn-secondary:hover { background: rgba(125,125,125,0.2); border-color: var(--primary); }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 6px; border-radius: 10px; color: var(--text-muted); transition: all 0.2s; cursor: pointer; font-weight: 500; border: 1px solid transparent; overflow: hidden; white-space: nowrap; }
        .nav-item:hover { background: rgba(125,125,125,0.1); color: var(--text-main); }
        .nav-item.active { background: var(--primary-glow); color: var(--text-main); border-color: var(--primary); }
        @media (min-width: 1025px) { .sidebar.collapsed { width: 5.5rem; } .sidebar.collapsed .sidebar-text, .sidebar.collapsed .sidebar-header-text { display: none; } .sidebar.collapsed .nav-item { justify-content: center; padding: 12px 0; } .sidebar.collapsed .nav-item i { margin-right: 0; font-size: 1.25rem; } .sidebar.collapsed .sidebar-logo-container { width: 40px; height: 40px; margin: 0 auto; } }
        .me-container { border: 1px solid var(--border); border-radius: 16px; background: var(--bg-panel); backdrop-filter: blur(20px); overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .me-table th { text-transform: uppercase; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.05em; color: var(--text-muted); padding: 1.25rem 1rem; border-bottom: 2px solid var(--border); background: rgba(0,0,0,0.3); cursor: pointer; user-select: none; white-space: nowrap; }
        .me-table th:hover { color: var(--text-main); background: rgba(125,125,125,0.1); }
        .me-table td { border-bottom: 1px solid var(--border); padding: 0.75rem 1rem; position: relative; vertical-align: middle; }
        .row-status { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; transition: 0.3s; }
        .rs-pass { background: #10b981; box-shadow: 4px 0 15px -2px rgba(16, 185, 129, 0.4); } .rs-fail { background: #ef4444; box-shadow: 4px 0 15px -2px rgba(239, 68, 68, 0.4); } .rs-neutral { background: transparent; }
        .mark-wrapper { position: relative; display: flex; align-items: center; justify-content: center; }
        .mark-input { background: rgba(0, 0, 0, 0.1); border: 1px solid var(--border); color: var(--text-main); text-align: center; width: 64px; padding: 10px 4px; border-radius: 8px; outline: none; font-weight: 600; font-family: 'Inter', sans-serif; transition: all 0.2s; }
        .mark-input:focus { background: var(--primary-glow); border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); transform: translateY(-1px); }
        .mark-input.fail-mark { color: #ef4444; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
        .att-input { border-color: rgba(251, 191, 36, 0.4); color: #fbbf24 !important; } .att-input:focus { border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2); }
        .stat-group { display: flex; flex-direction: column; align-items: flex-start; } .stat-label { font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted); font-weight: 800; letter-spacing: 1px; margin-bottom: 2px; } .stat-val { font-size: 1.25rem; font-weight: 700; color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; line-height: 1; }
        .fade-in { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(15px); } @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #global-loader { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 9999; } .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: var(--bg-dark); } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .a4-container { width: 210mm; min-height: 297mm; background: #fff; color: #1e293b; font-family: 'Inter', sans-serif; transform: scale(0.65); transform-origin: top left; margin: 0 auto; display: flex; flex-direction: column; }
        .transcript-frame { border: 8px solid #1e293b; outline: 2px solid #94a3b8; outline-offset: -12px; height: 100%; min-height: 290mm; margin: 8mm; position: relative; display: flex; flex-direction: column; background: #fff; }
        .transcript-inner { padding: 8mm 12mm; height: 100%; display: flex; flex-direction: column; background-image: radial-gradient(#f1f5f9 1px, transparent 1px); background-size: 25px 25px; }
        .mk-serif { font-family: 'Playfair Display', serif; } .mk-header-font { font-family: 'Cinzel', serif; } .mk-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; } .mk-table th { background: #f8fafc; color:#334155; padding: 10px; border-top: 2px solid #1e293b; border-bottom: 2px solid #1e293b; } .mk-table td { border-bottom: 1px solid #e2e8f0; padding: 10px; text-align: center; }
        .stamp-status { padding: 0.25rem 1rem; border: 2px solid; border-radius: 6px; font-weight: 800; text-transform: uppercase; display: inline-block; font-size: 0.85rem; } .pass { color: #059669; border-color: #059669; background: #ecfdf5; } .fail { color: #dc2626; border-color: #dc2626; background: #fef2f2; }
        @media (max-width: 1024px) { .sidebar { position: fixed !important; top: 0; left: 0; height: 100%; width: 280px; transform: translateX(-100%); background: var(--bg-dark); border-right: 1px solid var(--border); box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 100; } .sidebar.open { transform: translateX(0); } #view-dashboard { flex-direction: column; } main { width: 100% !important; max-width: 100% !important; margin: 0; padding: 0; flex: 1; display: flex; flex-direction: column; } #content-area { width: 100%; max-width: 100%; overflow-x: hidden; padding: 1rem; padding-bottom: calc(2rem + env(safe-area-inset-bottom)); } .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 90; } .overlay.open { display: block; } .me-table thead { display: none; } .me-table, .me-table tbody, .me-table tr, .me-table td { display: block; width: 100%; } .me-table tr { margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 12px; background: rgba(255,255,255,0.03); padding: 1rem; position: relative; } .me-table td { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border); text-align: right; background: transparent !important; } .me-table td:last-child { border-bottom: none; } .me-table td::before { content: attr(data-label); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); text-align: left; margin-right: 10px; } .mark-input { width: 80px; height: 44px; font-size: 1.1rem; } #modal-content-wrapper { position: fixed; bottom: 0; left: 0; width: 100%; max-width: 100%; border-radius: 20px 20px 0 0; max-height: 85vh; animation: slideUp 0.3s ease-out; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="overflow-hidden h-screen w-screen flex text-sm selection:bg-indigo-500/30">

    <div id="global-loader" class="fixed inset-0 flex flex-col items-center justify-center text-white z-[9999] hidden">
        <div class="spinner mb-4"></div>
        <p class="text-sm font-bold tracking-widest animate-pulse font-mono">SYNCING CLOUD...</p>
    </div>

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <section id="view-login" class="fixed inset-0 z-[60] flex items-center justify-center bg-dark hidden p-4">
        <div class="glass-panel p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-sm relative z-10 border-theme">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-panel rounded-2xl flex items-center justify-center text-3xl mx-auto mb-6 border-theme shadow-lg text-main">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight text-main">Staff Console</h1>
                <p class="text-muted text-xs uppercase tracking-widest mt-2">Secure Access</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-5">
                <div><label class="text-[10px] font-bold text-muted uppercase ml-1">Email</label><input type="email" id="login-email" class="input-field" required></div>
                <div><label class="text-[10px] font-bold text-muted uppercase ml-1">Password</label><input type="password" id="login-pass" class="input-field" required></div>
                <button id="btn-login" class="w-full btn-primary py-3.5 rounded-xl shadow-lg mt-2">Access Dashboard</button>
            </form>
            <div class="mt-8 text-center text-xs text-muted"><a id="link-return-portal" href="#" class="hover:text-main transition">Return to Portal</a></div>
        </div>
    </section>

    <div id="view-dashboard" class="hidden w-full h-full flex bg-dark overflow-hidden">
        
        <div id="mobile-overlay" onclick="toggleSidebar()" class="overlay"></div>

        <aside id="main-sidebar" class="sidebar bg-panel border-r border-theme flex flex-col flex-shrink-0 relative transition-all duration-300 backdrop-blur-md">
            <div class="p-6 lg:p-8 border-b border-theme flex items-center gap-4 sidebar-header">
                <div class="sidebar-logo-container w-10 h-10 rounded-xl flex items-center justify-center text-white bg-dark font-bold border border-white/10 overflow-hidden shadow-lg relative flex-shrink-0 transition-all" style="background-color: var(--primary);">
                    <img id="sidebar-logo" class="w-full h-full object-cover hidden">
                    <i id="sidebar-icon" class="fas fa-university text-lg"></i>
                </div>
                <div class="overflow-hidden sidebar-header-text">
                    <h2 class="font-bold text-main text-sm leading-tight truncate w-32" id="sidebar-inst-name">Loading...</h2>
                    <span class="text-[10px] text-muted font-mono uppercase tracking-wider font-bold" id="sidebar-role-text">Administrator</span>
                </div>
            </div>
            <nav class="flex-1 p-4 lg:p-5 space-y-2 overflow-y-auto overflow-x-hidden">
                <div class="text-[10px] font-extrabold text-muted uppercase tracking-widest mb-2 px-3 sidebar-text">Management</div>
                <div onclick="renderTab('overview')" class="nav-item active"><i class="fas fa-chart-line w-5 text-center shrink-0"></i> <span class="sidebar-text">Overview</span></div>
                <div onclick="renderTab('classes')" class="nav-item admin-only"><i class="fas fa-chalkboard w-5 text-center shrink-0"></i> <span class="sidebar-text">Classes</span></div>
                <div onclick="renderTab('students')" class="nav-item"><i class="fas fa-user-graduate w-5 text-center shrink-0"></i> <span class="sidebar-text">Students</span></div>
                <div onclick="renderTab('staff')" class="nav-item admin-only"><i class="fas fa-chalkboard-teacher w-5 text-center shrink-0"></i> <span class="sidebar-text">Staff / Teachers</span></div>
                
                <div class="text-[10px] font-extrabold text-muted uppercase tracking-widest mb-2 px-3 mt-6 sidebar-text">Academics</div>
                <div onclick="renderTab('exams')" class="nav-item admin-only"><i class="fas fa-clock w-5 text-center shrink-0"></i> <span class="sidebar-text">Exams</span></div>
                <div onclick="renderTab('publish')" class="nav-item"><i class="fas fa-edit w-5 text-center shrink-0"></i> <span class="sidebar-text">Result Entry</span></div>
                
                <div class="text-[10px] font-extrabold text-muted uppercase tracking-widest mb-2 px-3 mt-6 sidebar-text admin-only">System</div>
                <div onclick="renderTab('settings')" class="nav-item admin-only"><i class="fas fa-cog w-5 text-center shrink-0"></i> <span class="sidebar-text">School Profile</span></div>
            </nav>
            <div class="p-4 lg:p-5 border-t border-theme bg-panel">
                <button onclick="logout()" class="w-full py-3 lg:py-2.5 text-red-500 text-xs font-bold hover:bg-red-500/10 rounded-xl transition border border-red-500/20 flex items-center justify-center gap-2 overflow-hidden"><i class="fas fa-sign-out-alt shrink-0"></i> <span class="sidebar-text">Sign Out</span></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 relative h-full w-full overflow-hidden">
            
            <header class="h-16 lg:h-20 border-b border-theme bg-panel/95 backdrop-blur-xl flex items-center justify-between px-4 lg:px-8 sticky top-0 z-30 transition-colors duration-500 w-full shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden text-muted hover:text-main p-2 -ml-2"><i class="fas fa-bars text-xl"></i></button>
                    <button onclick="toggleDesktopSidebar()" class="hidden lg:block text-muted hover:text-main mr-2 transition-transform" id="desktop-sidebar-toggle"><i class="fas fa-outdent text-xl"></i></button>
                    
                    <div class="w-9 h-9 rounded-lg bg-dark flex items-center justify-center lg:hidden overflow-hidden border border-theme shadow-sm">
                        <img id="mobile-header-logo-admin" class="w-full h-full object-cover hidden">
                        <i id="mobile-header-icon-admin" class="fas fa-university text-xs" style="color: var(--primary)"></i>
                    </div>
                    <div class="lg:hidden flex flex-col justify-center">
                        <h2 id="mobile-header-school-admin" class="text-xs font-extrabold text-main leading-tight truncate max-w-[150px]">Loading...</h2>
                        <p class="text-[10px] text-muted truncate max-w-[150px] font-mono" id="mobile-role-text">Admin Console</p>
                    </div>
                    <h2 id="page-title" class="text-xl font-bold tracking-tight text-main hidden lg:block">Overview</h2>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="viewPublicPage()" class="px-3 py-1.5 md:px-4 md:py-2 bg-dark hover:bg-panel text-muted rounded-lg border border-theme transition text-xs font-bold flex items-center gap-2 hover:text-main"><span class="hidden md:inline">Homepage</span> <i class="fas fa-external-link-alt"></i></button>
                </div>
            </header>

            <div id="content-area" class="flex-1 overflow-y-auto overflow-x-hidden p-4 lg:p-10 w-full scroll-smooth"></div>
        </main>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-0 sm:p-4 fade-in overflow-hidden">
        <div class="glass-panel w-full max-w-4xl sm:rounded-2xl rounded-t-2xl overflow-hidden relative border-t border-theme h-[85dvh] sm:h-auto max-h-[90dvh] flex flex-col" id="modal-content-wrapper">
            <div class="p-4 md:p-6 border-b border-theme flex justify-between items-center bg-panel shrink-0">
                <h3 class="text-lg font-bold text-main" id="modal-title">Edit</h3>
                <button onclick="closeModal()" class="text-muted hover:text-main transition p-2 bg-dark rounded-full border border-theme w-8 h-8 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-body" class="p-4 md:p-6 bg-dark overflow-y-auto flex-1 w-full overflow-x-hidden"></div>
        </div>
    </div>

    <div id="promote-modal" class="hidden fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4 fade-in">
        <div class="glass-panel w-full max-w-md sm:rounded-2xl rounded-t-2xl overflow-hidden border-t border-theme pb-8 sm:pb-0" id="promote-content-wrapper">
            <div class="p-4 md:p-6 border-b border-theme flex justify-between items-center bg-panel">
                <h3 class="text-lg font-bold text-main">Bulk Promote Students</h3>
                <button onclick="$('promote-modal').classList.add('hidden')" class="sm:hidden text-muted hover:text-main transition p-2 bg-dark rounded-full border border-theme w-8 h-8 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 md:p-6 space-y-4 bg-dark">
                <p class="text-muted text-sm">Select the new class for the selected students:</p>
                <select id="promote-target-class" class="input-field"></select>
                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="$('promote-modal').classList.add('hidden')" class="hidden sm:block px-4 py-2 bg-dark text-main border-theme border rounded-lg text-sm">Cancel</button>
                    <button onclick="confirmPromote()" class="btn-primary w-full sm:w-auto px-6 py-2 text-sm">Promote</button>
                </div>
            </div>
        </div>
    </div>

    <div id="marksheet-modal" class="hidden fixed inset-0 z-[100] bg-dark sm:bg-black/95 sm:backdrop-blur-sm flex justify-center sm:items-center overflow-hidden fade-in">
        <div id="marksheet-modal-content" class="w-full sm:max-w-[210mm] relative bg-dark sm:bg-transparent h-[100dvh] sm:h-[90vh] sm:rounded-2xl flex flex-col">
            
            <div class="sticky top-0 w-full flex items-center justify-between sm:justify-end gap-2 p-3 sm:p-0 bg-panel/90 backdrop-blur-md sm:bg-transparent z-[110] border-b border-theme sm:border-none sm:absolute sm:-top-16 sm:right-0">
                <button onclick="closeModal()" class="sm:hidden bg-dark text-white w-10 h-10 rounded-full flex items-center justify-center border border-theme"><i class="fas fa-arrow-left"></i></button>
                <div class="flex gap-2">
                    <button onclick="downloadPDF()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 sm:px-5 sm:py-2.5 rounded-full text-xs font-bold shadow-lg flex items-center gap-2 transition border border-blue-400"><i class="fas fa-file-pdf"></i> Save</button>
                    <button onclick="closeModal()" class="hidden sm:flex bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-full text-xs font-bold backdrop-blur-md border border-white/10 transition items-center gap-2"><i class="fas fa-times"></i> Close</button>
                </div>
            </div>
            
            <div id="marksheet-scroll-area" class="flex-1 overflow-x-hidden overflow-y-auto w-full flex justify-center pb-20 sm:pb-0">
                <div id="mk-printable" class="a4-container">
                    <div class="transcript-frame">
                        <div class="watermark-layer"><img id="mk-watermark" class="watermark-logo"></div>
                        <div class="transcript-inner">
                            <div class="content-layer" id="mk-content-layer">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL BRANDING & SUPPORT LISTENER ---
        let supportWhatsapp = "";
        
        db.collection('site_config').doc('main').onSnapshot(doc => {
            if(doc.exists) {
                const data = doc.data();
                const brandName = data.brandName || 'easyresults';
                supportWhatsapp = data.whatsapp || '';
                
                const currentTitle = document.title.split('|')[0].trim();
                document.title = `${currentTitle} | ${brandName}`;
                document.querySelectorAll('.dynamic-brand-name').forEach(el => {
                    el.innerText = brandName;
                });
            }
        });

        const SESSION_KEY = 'easyresults_admin_session';
        let currentUser = null;
        let activeChart = null;
        let localState = { classes: [], exams: [], results: [], subjects: [], staff: [], students: [] };
        
        let lastStudentDoc = null;
        let hasMoreStudents = true;
        let currentSort = { key: 'rank', order: 'asc' };
        let draftGradeScale = [];

        function toggleSidebar() { 
            document.getElementById('main-sidebar').classList.toggle('open'); 
            document.getElementById('mobile-overlay').classList.toggle('open'); 
            document.getElementById('mobile-overlay').classList.toggle('hidden'); 
        }

        function toggleDesktopSidebar() {
            const sb = $('main-sidebar');
            const icon = document.querySelector('#desktop-sidebar-toggle i');
            sb.classList.toggle('collapsed');
            if(sb.classList.contains('collapsed')) {
                icon.classList.remove('fa-outdent');
                icon.classList.add('fa-indent');
            } else {
                icon.classList.remove('fa-indent');
                icon.classList.add('fa-outdent');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = $('btn-login'); btn.innerText = "Checking...";
            const email = $('login-email').value;
            const pass = $('login-pass').value;

            try {
                // PHASE 1 SECURITY: Authenticate against Firebase Auth securely
                const userCred = await auth.signInWithEmailAndPassword(email, pass);
                const uid = userCred.user.uid;

                // 1. Check if UID belongs to an Admin (Institution)
                let instDoc = await db.collection('institutions').doc(uid).get();
                
                if (instDoc.exists) {
                    if(instDoc.data().isActive === false) throw new Error("Account Suspended by Owner");
                    currentUser = { id: uid, role: 'admin', ...instDoc.data() };
                } else {
                    // 2. Check if UID belongs to a Teacher (Staff)
                    let staffSnap = await db.collection('staff').where('authUid', '==', uid).get();
                    
                    if (!staffSnap.empty) {
                        const staffDoc = staffSnap.docs[0];
                        const schoolDoc = await db.collection('institutions').doc(staffDoc.data().institutionId).get();
                        
                        if(!schoolDoc.exists || schoolDoc.data().isActive === false) throw new Error("Institution is Suspended");
                        
                        currentUser = { 
                            id: schoolDoc.id, 
                            staffId: staffDoc.id,
                            role: 'teacher', 
                            staffName: staffDoc.data().name,
                            ...schoolDoc.data() 
                        };
                    } else {
                        throw new Error("No admin or staff profile found.");
                    }
                }

                localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                initDashboard();

            } catch(e) { 
                console.error(e); 
                showToast("Invalid Credentials or Account Suspended", "error"); 
                btn.innerText = "Access Dashboard"; 
            }
        }

        function checkSession() {
            const session = localStorage.getItem(SESSION_KEY);
            if(session) { currentUser = JSON.parse(session); initDashboard(); } 
            else { 
                $('global-loader').classList.add('hidden'); 
                $('view-login').classList.remove('hidden'); 
                
                const lastSchool = localStorage.getItem('easyresults_last_school');
                const returnLink = document.getElementById('link-return-portal');
                if(returnLink) {
                    returnLink.href = lastSchool ? `home.html?id=${lastSchool}` : 'index.html';
                }
            }
        }

        async function initDashboard() {
            $('view-login').classList.add('hidden');
            $('global-loader').classList.remove('hidden');
            $('view-dashboard').classList.remove('hidden');
            
            const isTeacher = currentUser.role === 'teacher';
            if (isTeacher) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                $('sidebar-inst-name').innerText = currentUser.staffName;
                $('sidebar-role-text').innerText = "Teacher";
                $('mobile-header-school-admin').innerText = currentUser.staffName;
                $('mobile-role-text').innerText = "Teacher Console";
            } else {
                $('sidebar-inst-name').innerText = currentUser.name;
                $('mobile-header-school-admin').innerText = currentUser.name;
            }
            
            if(currentUser.profileImage) { 
                $('sidebar-logo').src = currentUser.profileImage; 
                $('sidebar-logo').classList.remove('hidden'); 
                $('sidebar-icon').classList.add('hidden'); 
                
                const mLogo = $('mobile-header-logo-admin');
                if(mLogo) { 
                    mLogo.src = currentUser.profileImage; 
                    mLogo.classList.remove('hidden'); 
                    $('mobile-header-icon-admin').classList.add('hidden'); 
                }
            }
            
            applyTheme(currentUser);
            await refreshData();
            $('global-loader').classList.add('hidden');
            renderTab('overview');
        }

        function logout() { 
            const instId = currentUser ? currentUser.id : null;
            if(instId) localStorage.setItem('easyresults_last_school', instId);
            
            auth.signOut();
            localStorage.removeItem(SESSION_KEY); 
            
            const lastSchool = localStorage.getItem('easyresults_last_school');
            window.location.href = lastSchool ? `home.html?id=${lastSchool}` : 'index.html';
        }
        
        function viewPublicPage() { window.open(`home.html?id=${currentUser.id}`, '_blank'); }
        window.onload = checkSession;

        async function refreshData() {
            try {
                const [c, e, sub, stf] = await Promise.all([
                    db.collection('classes').where('institutionId', '==', currentUser.id).get(),
                    db.collection('exams').where('institutionId', '==', currentUser.id).get(),
                    db.collection('subjects').where('institutionId', '==', currentUser.id).get(),
                    db.collection('staff').where('institutionId', '==', currentUser.id).get()
                ]);
                
                localState.classes = c.docs.map(d => ({id: d.id, ...d.data()}));
                localState.exams = e.docs.map(d => ({id: d.id, ...d.data()}));
                localState.subjects = sub.docs.map(d => ({id: d.id, ...d.data()}));
                localState.staff = stf.docs.map(d => ({id: d.id, ...d.data()}));
            } catch(e) { console.error("Sync Error", e); }
        }

        async function renderTab(tab) {
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(el => {
                if(el.getAttribute('onclick')) el.classList.toggle('active', el.getAttribute('onclick').includes(tab));
            });
            
            if(window.innerWidth < 1024) { 
                document.getElementById('main-sidebar').classList.remove('open'); 
                document.getElementById('mobile-overlay').classList.remove('open'); 
                document.getElementById('mobile-overlay').classList.add('hidden'); 
            }
            
            const content = $('content-area');
            const title = $('page-title');
            const isTeacher = currentUser.role === 'teacher';
            
            if(tab === 'overview') {
                title.innerText = 'Overview';
                await refreshData();
                
                showLoader(true);
                const sCountSnap = await db.collection('students').where('institutionId', '==', currentUser.id).count().get();
                const sCount = sCountSnap.data().count;
                const cCount = localState.classes.length;
                const eCount = localState.exams.length;

                const chartData = await Promise.all(localState.classes.map(c => 
                    db.collection('students').where('classId', '==', c.id).count().get()
                ));
                const chartValues = chartData.map(snap => snap.data().count);
                showLoader(false);

                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6 mb-6 lg:mb-8 fade-in">
                        <div class="glass-panel p-5 md:p-6 rounded-2xl border-l-4 border-l-blue-500"><p class="text-[10px] md:text-xs font-bold uppercase text-muted">Total Students</p><h3 class="text-2xl md:text-3xl font-bold mt-2 text-main">${sCount}</h3></div>
                        <div class="glass-panel p-5 md:p-6 rounded-2xl border-l-4 border-l-purple-500"><p class="text-[10px] md:text-xs font-bold uppercase text-muted">Active Classes</p><h3 class="text-2xl md:text-3xl font-bold mt-2 text-main">${cCount}</h3></div>
                        <div class="glass-panel p-5 md:p-6 rounded-2xl border-l-4 border-l-emerald-500"><p class="text-[10px] md:text-xs font-bold uppercase text-muted">Exams Conducted</p><h3 class="text-2xl md:text-3xl font-bold mt-2 text-main">${eCount}</h3></div>
                    </div>
                    <div class="glass-panel p-5 lg:p-8 rounded-2xl fade-in w-full overflow-hidden"><h4 class="text-sm md:text-lg font-bold mb-4 md:mb-6 text-main">Student Distribution</h4><div class="h-48 md:h-64 relative w-full"><canvas id="mainChart"></canvas></div></div>`;
                
                if(activeChart) activeChart.destroy();
                const ctx = $('mainChart').getContext('2d');
                activeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: localState.classes.map(c=>c.name),
                        datasets: [{ label: 'Students', data: chartValues, backgroundColor: currentUser.themeColor || '#6366f1', borderRadius: 6 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(125,125,125,0.1)' }, ticks: { color: 'var(--text-muted)' } }, x: { grid: { display: false }, ticks: { color: 'var(--text-muted)' } } } }
                });
            }

            if(tab === 'classes') {
                if(isTeacher) return renderTab('overview');
                title.innerText = 'Classes & Subjects';
                await refreshData();
                content.innerHTML = `
                    <div class="glass-panel p-4 md:p-6 rounded-2xl mb-4 md:mb-6 fade-in flex flex-col sm:flex-row gap-3 md:gap-4">
                        <input id="new-class" class="input-field" placeholder="Class Name (e.g. Grade 10-A)">
                        <button onclick="addClass()" class="btn-primary flex-shrink-0">Add Class</button>
                    </div>
                    <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6 fade-in">${localState.classes.map(c => `
                        <div class="glass-panel p-5 md:p-6 rounded-2xl group relative transition">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-base md:text-lg font-bold text-main">${c.name}</h3>
                                <div class="flex gap-2">
                                    <button onclick="editItem('classes','${c.id}')" class="text-muted hover:text-blue-400 transition p-2"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteItem('classes','${c.id}')" class="text-muted hover:text-red-400 transition p-2"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <button onclick="manageSubjects('${c.id}')" class="w-full py-3 bg-dark hover:bg-panel rounded-xl text-xs font-bold text-main transition border-theme">Manage ${localState.subjects.filter(s=>s.classId===c.id).length} Subjects</button>
                        </div>`).join('') || '<div class="text-muted p-4 col-span-full text-center">No classes found. Add one above.</div>'}
                    </div>`;
            }

            if(tab === 'staff') {
                if(isTeacher) return renderTab('overview');
                title.innerText = 'Staff Directory';
                await refreshData();
                content.innerHTML = `
                    <div class="grid lg:grid-cols-3 gap-4 md:gap-6 mb-6 fade-in">
                        <div class="glass-panel p-4 lg:p-6 rounded-2xl lg:col-span-1 h-fit">
                            <h4 class="font-bold mb-4 border-b border-theme pb-2 text-main">Register Teacher</h4>
                            <div class="space-y-3">
                                <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Full Name</label><input id="st-name" class="input-field text-sm" placeholder="e.g. Mr. Smith"></div>
                                <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Email (Login ID)</label><input id="st-email" type="email" class="input-field text-sm" placeholder="teacher@school.com"></div>
                                <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Password</label><input id="st-pass" class="input-field text-sm" placeholder="Secret Password"></div>
                                <button onclick="addStaff()" class="w-full btn-primary mt-4 py-3"><i class="fas fa-plus"></i> Add Staff Member</button>
                            </div>
                        </div>
                        <div class="glass-panel rounded-2xl lg:col-span-2 overflow-hidden flex flex-col w-full h-fit">
                            <div class="p-3 lg:p-4 border-b border-theme bg-panel"><h4 class="font-bold text-main">Active Staff Members</h4></div>
                            <div class="p-0 bg-panel/30">
                                ${localState.staff.length === 0 ? '<div class="p-8 text-center text-muted">No staff members found.</div>' : 
                                `<div class="divide-y divide-theme/50">${localState.staff.map(s => `
                                    <div class="p-4 flex justify-between items-center hover:bg-slate-800/10 transition group px-6 border-b border-theme/50 last:border-0">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-full bg-dark flex items-center justify-center text-primary border border-theme shadow-sm shrink-0"><i class="fas fa-chalkboard-teacher"></i></div>
                                            <div class="overflow-hidden">
                                                <p class="font-bold text-sm text-main truncate">${s.name}</p>
                                                <p class="text-[10px] text-muted font-mono">${s.email}</p>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 sm:opacity-50 group-hover:opacity-100 transition shrink-0">
                                            <button onclick="editItem('staff','${s.id}')" class="px-3 py-1.5 md:p-2 text-xs md:text-sm text-muted hover:text-blue-500 bg-dark md:bg-transparent rounded transition border border-theme md:border-transparent md:hover:border-theme shadow-sm md:shadow-none"><i class="fas fa-edit mr-1 md:mr-0"></i><span class="md:hidden">Edit</span></button>
                                            <button onclick="deleteItem('staff','${s.id}')" class="px-3 py-1.5 md:p-2 text-xs md:text-sm text-red-500 hover:bg-red-500 hover:text-white bg-dark md:bg-transparent rounded transition border border-theme md:border-transparent md:hover:border-red-500 shadow-sm md:shadow-none"><i class="fas fa-trash mr-1 md:mr-0"></i><span class="md:hidden">Delete</span></button>
                                        </div>
                                    </div>
                                `).join('')}</div>`}
                            </div>
                        </div>
                    </div>`;
            }

            if(tab === 'students') {
                title.innerText = 'Student Directory';
                await refreshData();
                const opts = localState.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                
                content.innerHTML = `
                    <div class="glass-panel p-4 lg:p-6 rounded-2xl mb-6 fade-in flex flex-col md:flex-row justify-between items-center gap-4 ${isTeacher ? 'hidden' : ''}">
                        <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                            <button onclick="openRegisterModal()" class="btn-primary w-full sm:w-auto"><i class="fas fa-plus"></i> Register Student</button>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button onclick="downloadStudentTemplate()" class="btn-secondary flex-1 sm:w-auto text-xs"><i class="fas fa-download mr-1"></i> Template</button>
                                <button onclick="exportStudents()" class="btn-secondary flex-1 sm:w-auto text-xs"><i class="fas fa-file-export mr-1"></i> Export Data</button>
                            </div>
                            </div>
                    </div>
                    
                    <div class="glass-panel rounded-2xl overflow-hidden flex flex-col fade-in shadow-xl w-full h-fit">
                        <div class="p-3 lg:p-4 border-b border-theme bg-panel flex flex-col md:flex-row gap-3 items-center justify-between">
                            <div class="flex items-center gap-3 w-full md:w-auto flex-1">
                                <i class="fas fa-search text-muted pl-2"></i>
                                <input id="s-search" onkeyup="if(event.key === 'Enter') { resetPagination(); fetchStudents(); }" class="input-field bg-transparent border-none shadow-none focus:ring-0 p-0 w-full min-h-[30px]" placeholder="Search by Admission No (Press Enter)...">
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <select id="s-filter-class" onchange="resetPagination(); fetchStudents();" class="input-field w-full sm:w-auto text-xs py-2 cursor-pointer"><option value="">All Classes</option>${opts}</select>
                            </div>
                            ${!isTeacher ? `<button onclick="openPromoteModal()" id="btn-promote" class="hidden w-full sm:w-auto px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition min-h-[44px]">Promote</button>` : ''}
                        </div>
                        <div class="px-4 lg:px-6 py-2.5 bg-dark text-[10px] uppercase font-bold text-muted flex items-center gap-3 border-b border-theme shrink-0">
                            ${!isTeacher ? `<input type="checkbox" id="check-all" class="rounded bg-dark border-theme" onchange="toggleSelectAll(this)"> <span>Select All</span>` : `<span>Student Name</span>`}
                        </div>
                        <div class="p-0 bg-panel/30 w-full" id="student-list"></div>
                        <div class="p-4 border-t border-theme text-center bg-panel/50">
                            <button id="btn-load-more" onclick="fetchStudents(true)" class="px-6 py-2 bg-dark hover:bg-slate-800 border border-theme text-muted hover:text-main rounded-xl text-xs font-bold transition hidden shadow-sm"><i class="fas fa-chevron-down mr-2"></i> Load More Students</button>
                        </div>
                    </div>
                `;
                resetPagination();
                fetchStudents();
            }

            if(tab === 'exams') {
                if(isTeacher) return renderTab('overview');
                title.innerText = 'Exams';
                await refreshData();
                content.innerHTML = `
                    <div class="glass-panel p-4 md:p-6 rounded-2xl mb-4 md:mb-6 fade-in flex flex-col md:flex-row gap-3 md:gap-4 items-end">
                        <div class="flex-grow w-full md:w-auto">
                            <label class="text-[10px] md:text-xs font-bold text-muted uppercase mb-1 block">Exam Title</label>
                            <input id="new-exam" class="input-field" placeholder="e.g. Finals">
                        </div>
                        <div class="w-full md:w-auto">
                            <label class="text-[10px] md:text-xs font-bold text-muted uppercase mb-1 block">Academic Year</label>
                            <select id="new-exam-year" class="input-field text-muted w-full cursor-pointer">
                                <option value="2023-2024">2023-2024</option>
                                <option value="2024-2025" selected>2024-2025</option>
                                <option value="2025-2026">2025-2026</option>
                            </select>
                        </div>
                        <div class="w-full md:w-auto">
                            <label class="text-[10px] md:text-xs font-bold text-muted uppercase mb-1 block">Result Publish Date</label>
                            <input id="new-exam-date" type="datetime-local" class="input-field text-muted w-full">
                        </div>
                        <button onclick="addExam()" class="btn-primary flex-shrink-0 w-full md:w-auto mt-2 md:mt-0">Create Exam</button>
                    </div>
                    <div class="space-y-3 fade-in">${localState.exams.map(e=> {
                        const d = e.publishDate ? new Date(e.publishDate).toLocaleString() : 'Immediate';
                        const isPub = e.isPublished || false;
                        return `
                        <div class="glass-panel p-4 rounded-xl flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 group">
                            <div>
                                <span class="font-bold block text-main">${e.name} <span class="text-indigo-400 text-xs ml-2">[${e.academicYear || 'N/A'}]</span></span>
                                <span class="text-[10px] text-muted font-mono block mt-1"><i class="fas fa-clock mr-1"></i> Scheduled: ${d}</span>
                            </div>
                            <div class="flex gap-3 items-center w-full sm:w-auto justify-between sm:justify-end mt-2 sm:mt-0">
                                <button onclick="toggleExamPublish('${e.id}', ${isPub})" class="px-3 py-2 sm:py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition border flex-1 sm:flex-none text-center justify-center flex items-center ${isPub ? 'bg-emerald-500/10 text-emerald-600 border-emerald-500/30' : 'bg-dark text-muted border-theme hover:bg-panel hover:text-main'}">
                                    ${isPub ? '<i class="fas fa-eye mr-1"></i> Published' : '<i class="fas fa-eye-slash mr-1"></i> Unpublished'}
                                </button>
                                <div class="flex gap-2 sm:opacity-50 group-hover:opacity-100 transition shrink-0">
                                    <button onclick="editItem('exams','${e.id}')" class="text-muted hover:text-blue-500 p-2 bg-dark sm:bg-transparent rounded border border-theme sm:border-transparent"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteItem('exams','${e.id}')" class="text-red-500 sm:text-muted hover:text-red-500 p-2 bg-dark sm:bg-transparent rounded border border-theme sm:border-transparent"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                    </div>`;
            }

            if(tab === 'publish') {
                title.innerText = 'Result Entry';
                await refreshData();
                content.innerHTML = `
                    <div class="glass-panel p-5 md:p-8 rounded-2xl max-w-full mx-auto fade-in text-center border-t-4 border-indigo-500 w-full">
                        <h3 class="text-xl md:text-2xl font-bold mb-2 text-main">Enter Results</h3>
                        <p class="text-xs md:text-sm text-muted mb-6">Select exam and class to enter marks. Existing marks will load automatically.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-6">
                            <select id="pub-exam" class="input-field cursor-pointer"><option value="">Select Exam</option>${localState.exams.map(e=>`<option value="${e.id}">[${e.academicYear || 'Year'}] ${e.name}</option>`)}</select>
                            <select id="pub-class" class="input-field cursor-pointer"><option value="">Select Class</option>${localState.classes.map(c=>`<option value="${c.id}">${c.name}</option>`)}</select>
                        </div>
                        <button onclick="loadResultGrid()" class="btn-primary px-10 py-3 rounded-xl shadow-lg mx-auto w-full md:w-auto">Load Console</button>
                    </div>
                    <div id="result-grid-container" class="mt-6 md:mt-8 fade-in w-full"></div>`;
            }

            if(tab === 'settings') {
                if(isTeacher) return renderTab('overview');
                title.innerText = 'School Profile';
                const i = currentUser;
                const currentTemplate = i.gradeScale || 'standard';
                const hasAccess = i.hasFullAccess === true;
                
                if(i.customGradeScale) { draftGradeScale = JSON.parse(JSON.stringify(i.customGradeScale)); } 
                else { draftGradeScale = JSON.parse(JSON.stringify(DEFAULT_SCALES[currentTemplate])); }

                content.innerHTML = `
                    <div class="w-full fade-in space-y-4 md:space-y-6 max-w-none mx-auto">
                        <div class="glass-panel p-5 md:p-8 rounded-2xl">
                            <h4 class="font-bold border-b border-theme pb-3 md:pb-4 mb-4 md:mb-6 text-main">Identity & Branding</h4>
                            <div class="grid md:grid-cols-2 gap-4 md:gap-6 mb-6">
                                <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">School Name</label><input id="set-name" class="input-field mt-1" value="${i.name}"></div>
                                <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Tagline</label><input id="set-tag" class="input-field mt-1" value="${i.tagline||''}"></div>
                                <div class="md:col-span-2"><label class="text-[10px] md:text-xs font-bold text-muted uppercase">About</label><textarea id="set-about" class="input-field mt-1" rows="3">${i.aboutText||''}</textarea></div>
                                
                                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6 mt-2 pt-6 border-t border-theme">
                                    <div>
                                        <label class="text-[10px] md:text-xs font-bold text-muted uppercase">Brand Color</label>
                                        <div class="flex items-center gap-4 mt-2">
                                            <input type="color" id="set-color" class="w-12 h-12 rounded cursor-pointer bg-transparent border-0 p-0" value="${i.themeColor || '#6366f1'}">
                                            <span class="text-xs text-muted">Select your primary accent color</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-[10px] md:text-xs font-bold text-muted uppercase">Visual Theme Preset</label>
                                        <select id="set-theme" class="input-field mt-2 cursor-pointer">
                                            <option value="deep_space" ${i.theme === 'deep_space' ? 'selected' : ''}>Deep Space (Default)</option>
                                            <option value="minimal_light" ${i.theme === 'minimal_light' ? 'selected' : ''}>Minimal Light</option>
                                            <option value="midnight_blue" ${i.theme === 'midnight_blue' ? 'selected' : ''}>Midnight Blue</option>
                                            <option value="emerald_city" ${i.theme === 'emerald_city' ? 'selected' : ''}>Emerald City</option>
                                            <option value="crimson_fury" ${i.theme === 'crimson_fury' ? 'selected' : ''}>Crimson Fury</option>
                                            <option value="royal_purple" ${i.theme === 'royal_purple' ? 'selected' : ''}>Royal Purple</option>
                                            <option value="classic_academia" ${i.theme === 'classic_academia' ? 'selected' : ''}>Classic Academia</option>
                                            <option value="modern_teal" ${i.theme === 'modern_teal' ? 'selected' : ''}>Modern Teal</option>
                                            <option value="solar_flare" ${i.theme === 'solar_flare' ? 'selected' : ''}>Solar Flare</option>
                                            <option value="oceanic_depth" ${i.theme === 'oceanic_depth' ? 'selected' : ''}>Oceanic Depth</option>
                                            <option value="slate_minimal" ${i.theme === 'slate_minimal' ? 'selected' : ''}>Slate Minimal</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="md:col-span-2 mt-2 pt-6 border-t border-theme w-full overflow-hidden">
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                                        <div>
                                            <h4 class="font-bold text-main">Custom Grading Scale</h4>
                                            <p class="text-[10px] md:text-xs text-muted">Define the grade letters and minimum percentages required.</p>
                                        </div>
                                        <div class="flex items-center w-full sm:w-auto">
                                            <select id="set-grade-scale" class="input-field py-2 sm:py-1.5 px-3 text-xs w-full sm:w-auto cursor-pointer" onchange="changeGradeTemplate(this.value)">
                                                <option value="standard" ${currentTemplate === 'standard' ? 'selected' : ''}>Load Standard Template</option>
                                                <option value="gpa" ${currentTemplate === 'gpa' ? 'selected' : ''}>Load GPA Template</option>
                                                <option value="o_level" ${currentTemplate === 'o_level' ? 'selected' : ''}>Load O-Level Template</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="grade-scale-editor" class="mb-4 bg-black/20 p-3 md:p-4 rounded-xl border border-theme overflow-x-hidden w-full"></div>
                                    <button onclick="addGradeRow()" class="btn-secondary text-xs w-full sm:w-auto"><i class="fas fa-plus"></i> Add Grade Boundary</button>
                                </div>

                            </div>
                        </div>
                        <div class="glass-panel p-5 md:p-8 rounded-2xl">
                            <h4 class="font-bold border-b border-theme pb-3 md:pb-4 mb-4 md:mb-6 text-main">Contact & Assets</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6 mb-6">
                                <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Email</label><input id="set-email" class="input-field mt-1" value="${i.contactEmail||''}"></div>
                                <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Phone</label><input id="set-phone" class="input-field mt-1" value="${i.contactPhone||''}"></div>
                                <div class="sm:col-span-2"><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Address</label><input id="set-addr" class="input-field mt-1" value="${i.address||''}"></div>
                                
                                <div class="${!hasAccess ? 'opacity-50 grayscale pointer-events-none' : ''}">
                                    <label class="text-[10px] md:text-xs font-bold text-muted uppercase flex items-center gap-2">School Logo URL ${!hasAccess ? '<i class="fas fa-lock text-yellow-500"></i>' : ''}</label>
                                    <input type="url" id="set-logo" class="input-field mt-1 text-sm" value="${i.profileImage||''}" placeholder="https://..." ${!hasAccess ? 'disabled' : ''}>
                                </div>
                                <div class="${!hasAccess ? 'opacity-50 grayscale pointer-events-none' : ''}">
                                    <label class="text-[10px] md:text-xs font-bold text-muted uppercase flex items-center gap-2">Principal Signature URL ${!hasAccess ? '<i class="fas fa-lock text-yellow-500"></i>' : ''}</label>
                                    <input type="url" id="set-sig" class="input-field mt-1 text-sm" value="${i.signatureImage||''}" placeholder="https://..." ${!hasAccess ? 'disabled' : ''}>
                                </div>
                                
                                ${!hasAccess ? `
                                <div class="sm:col-span-2 text-[10px] font-bold text-yellow-500 bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-xl mt-2 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                                    <div class="flex items-start sm:items-center gap-2">
                                        <i class="fas fa-shield-alt text-lg mt-0.5 sm:mt-0"></i> 
                                        <span>School branding assets are locked for security. Contact easyresults support to update your Logo and Principal Signature.</span>
                                    </div>
                                    <button onclick="contactSupport()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg transition text-xs font-bold flex items-center gap-2 shrink-0 border border-green-500 w-full sm:w-auto justify-center shadow-lg shadow-green-900/20">
                                        <i class="fab fa-whatsapp text-sm"></i> Chat Support
                                    </button>
                                </div>` : ''}
                            </div>
                        </div>
                        <button onclick="saveSettings()" class="w-full btn-primary py-4 rounded-xl shadow-lg">Save & Update Profile</button>
                    </div>`;

                setTimeout(renderGradeScaleEditor, 0);
            }
        }

        // --- CUSTOM GRADE SCALE EDITOR LOGIC ---
        function renderGradeScaleEditor() {
            draftGradeScale.sort((a, b) => b.m - a.m);
            let html = `
                <div class="flex gap-2 text-[10px] uppercase font-bold text-muted px-2 mb-2 w-full">
                    <div class="flex-1">Grade Letter / Name</div>
                    <div class="flex-1">Minimum % Required</div>
                    <div class="w-8"></div>
                </div>
            `;
            draftGradeScale.forEach((row, idx) => {
                html += `
                <div class="flex items-center gap-2 mb-2 w-full">
                    <input type="text" class="input-field py-2 flex-1 min-w-0" value="${row.g}" onchange="updateGradeRow(${idx}, 'g', this.value)" placeholder="e.g. A+">
                    <input type="number" class="input-field py-2 flex-1 min-w-0" value="${row.m}" onchange="updateGradeRow(${idx}, 'm', this.value)" placeholder="e.g. 90">
                    <button onclick="removeGradeRow(${idx})" class="text-slate-600 hover:text-red-500 p-2 transition shrink-0 bg-dark md:bg-transparent rounded-lg border border-theme md:border-transparent"><i class="fas fa-trash"></i></button>
                </div>`;
            });
            if(draftGradeScale.length === 0) html += `<div class="text-center text-muted text-xs py-4">No grades configured. Please add boundaries.</div>`;
            $('grade-scale-editor').innerHTML = html;
        }

        function updateGradeRow(idx, field, val) {
            if(field === 'm') val = Number(val);
            draftGradeScale[idx][field] = val;
        }

        function addGradeRow() {
            draftGradeScale.push({g: 'New', m: 0});
            renderGradeScaleEditor();
        }

        function removeGradeRow(idx) {
            draftGradeScale.splice(idx, 1);
            renderGradeScaleEditor();
        }

        function changeGradeTemplate(val) {
            if(confirm("Load default template? This will overwrite your current custom scale below.")) {
                draftGradeScale = JSON.parse(JSON.stringify(DEFAULT_SCALES[val]));
                renderGradeScaleEditor();
            } else {
                $('set-grade-scale').value = currentUser.gradeScale || 'standard';
            }
        }

        // --- UNIVERSAL EDIT FUNCTION ---
        function openRegisterModal() {
            $('modal-overlay').classList.remove('hidden');
            $('modal-title').innerText = `Register New Student`; 
            const opts = localState.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            $('modal-body').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Full Name</label><input id="s-name" class="input-field text-sm" placeholder="Full Name"></div>
                        <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Admission No</label><input id="s-adm" class="input-field text-sm" placeholder="Unique ID"></div>
                        <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Date of Birth</label><input id="s-dob" type="date" class="input-field text-muted text-sm"></div>
                        <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Class</label><select id="s-class" class="input-field text-muted text-sm"><option value="">Select Class...</option>${opts}</select></div>
                    </div>
                    <div class="border-t border-theme pt-4 mt-2">
                        <h4 class="text-[10px] md:text-xs font-bold text-main mb-3 uppercase tracking-wider">Guardian Details</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Parent/Guardian Name</label><input id="s-parent" class="input-field text-sm" placeholder="Name"></div>
                            <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Mobile Number</label><input id="s-phone" class="input-field text-sm" placeholder="Phone"></div>
                            <div class="sm:col-span-2"><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Home Address</label><input id="s-address" class="input-field text-sm" placeholder="Full Address"></div>
                        </div>
                    </div>
                    <button onclick="addStudent()" class="w-full btn-primary mt-4 py-3"><i class="fas fa-shield-alt mr-2"></i> Register Securely</button>
                </div>`;
        }

        function editItem(type, id) {
            $('modal-overlay').classList.remove('hidden');
            $('modal-title').innerText = `Edit ${type.slice(0, -1)}`; 
            
            const item = type === 'subjects' ? localState.subjects.find(s => s.id === id) : localState[type].find(x => x.id === id);
            let html = '';
            
            if(type === 'classes') {
                html = `<div class="space-y-4"><div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Name</label><input id="edit-val-name" class="input-field" value="${item.name}"></div><button onclick="saveEdit('${type}', '${id}')" class="w-full btn-primary">Save Changes</button></div>`;
            } 
            else if(type === 'students') {
                const classOpts = localState.classes.map(c => `<option value="${c.id}" ${c.id === item.classId ? 'selected' : ''}>${c.name}</option>`).join('');
                html = `<div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Full Name</label><input id="edit-val-name" class="input-field text-sm" value="${item.name}"></div>
                        <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase flex items-center gap-2">Admission No <i class="fas fa-lock text-yellow-500" title="Locked by Auth"></i></label><input id="edit-val-adm" class="input-field text-sm bg-dark" value="${item.admissionNo}" disabled></div>
                        <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Date of Birth</label><input id="edit-val-dob" type="date" class="input-field text-muted text-sm" value="${item.dob || ''}"></div>
                        <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Class</label><select id="edit-val-class" class="input-field text-muted text-sm">${classOpts}</select></div>
                    </div>
                    <div class="border-t border-theme pt-4 mt-2">
                        <h4 class="text-[10px] md:text-xs font-bold text-main mb-3 uppercase tracking-wider">Guardian Details</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Parent/Guardian Name</label><input id="edit-val-parent" class="input-field text-sm" value="${item.parentName || ''}"></div>
                            <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Mobile Number</label><input id="edit-val-phone" class="input-field text-sm" value="${item.contactPhone || ''}"></div>
                            <div class="sm:col-span-2"><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Home Address</label><input id="edit-val-address" class="input-field text-sm" value="${item.address || ''}"></div>
                        </div>
                    </div>
                    <button onclick="saveEdit('${type}', '${id}')" class="w-full btn-primary mt-4">Save Changes</button>
                </div>`;
            }
            else if(type === 'staff') {
                html = `<div class="space-y-4">
                    <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Full Name</label><input id="edit-val-name" class="input-field text-sm" value="${item.name}"></div>
                    <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase flex items-center gap-2">Email (Login ID) <i class="fas fa-lock text-yellow-500" title="Locked by Auth"></i></label><input id="edit-val-email" type="email" class="input-field text-sm bg-dark" value="${item.email}" disabled></div>
                    <div class="text-[10px] text-slate-500 bg-slate-800/50 p-3 rounded-lg border border-slate-700 mt-4">
                        <i class="fas fa-shield-alt text-blue-400 mr-1"></i> Passwords are encrypted by Google. Staff can reset passwords from the login page.
                    </div>
                    <button onclick="saveEdit('${type}', '${id}')" class="w-full btn-primary mt-4">Save Changes</button>
                </div>`;
            }
            else if(type === 'exams') {
                let dateVal = '';
                if(item.publishDate) { const d = new Date(item.publishDate); dateVal = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16); }
                html = `<div class="space-y-4">
                    <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Exam Name</label><input id="edit-val-name" class="input-field" value="${item.name}"></div>
                    <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Academic Year</label><input id="edit-val-year" class="input-field" value="${item.academicYear || ''}"></div>
                    <div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Publish Date</label><input id="edit-val-date" type="datetime-local" class="input-field text-muted" value="${dateVal}"></div>
                    <button onclick="saveEdit('${type}', '${id}')" class="w-full btn-primary">Save Changes</button>
                </div>`;
            }
            else if(type === 'subjects') {
                html = `<div class="space-y-4"><div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Subject Name</label><input id="edit-sub-name" class="input-field" value="${item.name}"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Total Marks</label><input id="edit-sub-full" type="number" class="input-field" value="${item.fullMarks}"></div><div><label class="text-[10px] md:text-xs font-bold text-muted uppercase">Pass Marks</label><input id="edit-sub-pass" type="number" class="input-field" value="${item.passMarks}"></div></div><input type="hidden" id="edit-sub-cid" value="${item.classId}"><button onclick="saveEdit('subjects', '${id}')" class="w-full btn-primary">Update Subject</button></div>`;
            }
            $('modal-body').innerHTML = html;
        }

        async function saveEdit(type, id) {
            showLoader(true); let updateData = {};
            
            if(type === 'classes') updateData = { name: $('edit-val-name').value };
            else if(type === 'students') {
                updateData = { 
                    name: $('edit-val-name').value, 
                    dob: $('edit-val-dob').value, 
                    classId: $('edit-val-class').value,
                    parentName: $('edit-val-parent').value,
                    contactPhone: $('edit-val-phone').value,
                    address: $('edit-val-address').value
                };
            }
            else if(type === 'staff') {
                updateData = { name: $('edit-val-name').value };
            }
            else if(type === 'exams') { const d = $('edit-val-date').value; updateData = { name: $('edit-val-name').value, academicYear: $('edit-val-year').value, publishDate: d ? new Date(d).toISOString() : new Date().toISOString() }; }
            else if(type === 'subjects') updateData = { name: $('edit-sub-name').value, fullMarks: Number($('edit-sub-full').value), passMarks: Number($('edit-sub-pass').value) };
            
            await db.collection(type).doc(id).update(updateData);
            $('modal-overlay').classList.add('hidden'); 
            showLoader(false); 
            showToast("Updated Successfully");
            
            if(type === 'subjects') manageSubjects($('edit-sub-cid').value); 
            else await renderTab(type);
        }

        function closeModal() { $('modal-overlay').classList.add('hidden'); $('marksheet-modal').classList.add('hidden'); }

        async function addClass() { const n = $('new-class').value; if(n) { showLoader(true); await db.collection('classes').add({ institutionId: currentUser.id, name: n, createdAt: new Date().toISOString() }); await renderTab('classes'); showLoader(false); showToast("Class Added"); } }
        
        async function addStudent() {
            const n=$('s-name').value, a=$('s-adm').value, c=$('s-class').value, d=$('s-dob').value;
            const pName=$('s-parent').value, phone=$('s-phone').value, addr=$('s-address').value;
            
            if(n&&a&&c) { 
                showLoader(true); 
                const snap = await db.collection('students').where('institutionId', '==', currentUser.id).where('admissionNo', '==', a).get();
                if(!snap.empty) { showLoader(false); return showToast("Admission No exists", "error"); } 
                
                try {
                    // PHASE 1 SECURITY: Generate a dummy email so Firebase Auth works with Admission Numbers
                    const safeAdm = a.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                    const dummyEmail = `${safeAdm}@${currentUser.id.toLowerCase()}.edu`;
                    
                    const userCred = await secondaryAuth.createUserWithEmailAndPassword(dummyEmail, a); // Default pass is Adm No

                    await db.collection('students').doc(userCred.user.uid).set({ 
                        institutionId: currentUser.id, 
                        authUid: userCred.user.uid,
                        dummyEmail: dummyEmail,
                        name: n, admissionNo: a, classId: c, dob: d,
                        parentName: pName, contactPhone: phone, address: addr
                    }); 
                    
                    await renderTab('students');
                    closeModal();
                    showToast("Student Registered Securely"); 
                } catch(err) {
                    showToast(err.message, "error");
                }
                showLoader(false); 
            } else {
                showToast("Name, Adm No and Class are required", "error");
            }
        }

        async function addStaff() {
            const n=$('st-name').value, e=$('st-email').value, p=$('st-pass').value;
            if(n&&e&&p) {
                showLoader(true);
                try {
                    // PHASE 1 SECURITY: Create Teacher in Auth
                    const userCred = await secondaryAuth.createUserWithEmailAndPassword(e, p);
                    
                    await db.collection('staff').doc(userCred.user.uid).set({
                        institutionId: currentUser.id,
                        authUid: userCred.user.uid,
                        name: n, email: e, createdAt: new Date().toISOString()
                    });
                    
                    await renderTab('staff');
                    showToast("Teacher Registered Securely");
                } catch(err) {
                    showToast(err.message, "error");
                }
                showLoader(false); 
            } else {
                showToast("All fields are required", "error");
            }
        }
        
        async function addExam() {
            const n = $('new-exam').value; const y = $('new-exam-year').value; const d = $('new-exam-date').value;
            if(n) { showLoader(true); const pubDate = d ? new Date(d).toISOString() : new Date().toISOString(); await db.collection('exams').add({ institutionId: currentUser.id, name: n, academicYear: y, publishDate: pubDate, isPublished: false }); await renderTab('exams'); showLoader(false); showToast("Exam Created"); }
        }

        async function deleteItem(col, id) {
            if(confirm("Permanently Delete? (Warning: Data cannot be recovered)")) { 
                showLoader(true); 
                const batch = db.batch();
                batch.delete(db.collection(col).doc(id));
                
                if(col === 'students') {
                    const res = await db.collection('results').where('studentId', '==', id).get();
                    res.forEach(r => batch.delete(r.ref));
                } else if(col === 'exams') {
                    const res = await db.collection('results').where('examId', '==', id).get();
                    res.forEach(r => batch.delete(r.ref));
                }
                
                await batch.commit(); 
                const activeTab = document.querySelector('.nav-item.active').getAttribute('onclick').match(/'(.*)'/)[1]; 
                await renderTab(activeTab); 
                showLoader(false); 
                showToast("Deleted successfully"); 
            }
        }

        async function toggleExamPublish(id, currentStatus) {
            showLoader(true); await db.collection('exams').doc(id).update({ isPublished: !currentStatus }); await refreshData(); await renderTab('exams'); showLoader(false); showToast(!currentStatus ? "Exam Published" : "Exam Unpublished");
        }

        function toggleSelectAll(checkbox) { document.querySelectorAll('.stu-check').forEach(c => c.checked = checkbox.checked); updateBulkState(); }
        function updateBulkState() {
            const count = document.querySelectorAll('.stu-check:checked').length; const btn = $('btn-promote');
            if(btn) { if (count > 0) { btn.classList.remove('hidden'); btn.innerText = `Promote (${count})`; } else { btn.classList.add('hidden'); } }
        }
        function openPromoteModal() {
            const opts = localState.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            $('promote-target-class').innerHTML = `<option value="">Select New Class</option>` + opts;
            $('promote-modal').classList.remove('hidden');
        }
        async function confirmPromote() {
            const targetClassId = $('promote-target-class').value;
            if (!targetClassId) return showToast("Please select a class", "error");
            const selectedIds = Array.from(document.querySelectorAll('.stu-check:checked')).map(cb => cb.value);
            if(selectedIds.length === 0) return;
            
            showLoader(true);
            const batch = db.batch(); let count = 0;
            selectedIds.forEach(id => { const ref = db.collection('students').doc(id); batch.update(ref, { classId: targetClassId }); count++; });
            await batch.commit(); await refreshData();
            $('promote-modal').classList.add('hidden'); 
            resetPagination(); fetchStudents(); 
            showLoader(false); showToast(`Promoted ${count} Students`);
        }

        function manageSubjects(cid) { $('modal-overlay').classList.remove('hidden'); $('modal-title').innerText = "Manage Subjects"; renderSubjectModal(cid); }
        function renderSubjectModal(cid, defFull='100', defPass='33') {
            const subs = localState.subjects.filter(s => s.classId === cid);
            $('modal-body').innerHTML = `
                <div class="flex flex-col gap-3 mb-4 p-4 bg-panel rounded-xl border border-theme">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <div class="sm:col-span-3"><label class="text-[10px] uppercase font-bold text-muted">Subject Name</label><input id="sb-n" class="input-field text-xs" placeholder="e.g. Mathematics"></div>
                        <div><label class="text-[10px] uppercase font-bold text-muted">Total Marks</label><input id="sb-f" type="number" class="input-field text-xs" value="${defFull}"></div>
                        <div><label class="text-[10px] uppercase font-bold text-muted">Pass Mark</label><input id="sb-p" type="number" class="input-field text-xs" value="${defPass}"></div>
                        <div class="flex items-end"><button onclick="addSub('${cid}')" class="w-full btn-primary text-xs py-2.5 rounded-lg"><i class="fas fa-plus"></i> Add</button></div>
                    </div>
                </div>
                <div class="space-y-2 max-h-60 overflow-y-auto pr-2 w-full overflow-x-hidden">
                    ${subs.map(s => `<div class="flex justify-between bg-panel p-3 rounded-lg border border-theme text-xs items-center group w-full">
                        <span class="font-bold text-main min-w-0 truncate">${s.name} <span class="text-muted font-normal ml-1 hidden sm:inline">(Max: ${s.fullMarks})</span></span>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="editItem('subjects', '${s.id}')" class="text-muted hover:text-blue-500 p-2 bg-dark rounded border border-theme sm:border-transparent"><i class="fas fa-edit"></i></button>
                            <button onclick="delSub('${s.id}','${cid}')" class="text-red-500 sm:text-muted hover:text-red-500 p-2 bg-dark rounded border border-theme sm:border-transparent"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('')}
                </div>`;
        }
        async function addSub(cid) { const n=$('sb-n').value, f=$('sb-f').value, p=$('sb-p').value; if(n) { await db.collection('subjects').add({ institutionId: currentUser.id, classId: cid, name: n, fullMarks: Number(f), passMarks: Number(p) }); await refreshData(); renderSubjectModal(cid, f, p); } }
        async function delSub(sid, cid) { await db.collection('subjects').doc(sid).delete(); await refreshData(); renderSubjectModal(cid); }

        function downloadStudentTemplate() { 
            const ws = XLSX.utils.aoa_to_sheet([["Full Name", "Admission No", "Date of Birth (YYYY-MM-DD)", "Class Name", "Parent Name", "Contact Phone", "Address"]]); 
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Students"); XLSX.writeFile(wb, "Student_Template.xlsx"); 
        }

        async function exportStudents() {
            showLoader(true);
            try {
                const snap = await db.collection('students').where('institutionId', '==', currentUser.id).get();
                const allStus = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                if (allStus.length === 0) { showLoader(false); return showToast("No students to export", "error"); }

                const data = allStus.map(s => {
                    const cls = localState.classes.find(c => c.id === s.classId);
                    return { "Full Name": s.name, "Admission No": s.admissionNo, "Date of Birth": s.dob || "", "Class Name": cls ? cls.name : "Unassigned", "Parent Name": s.parentName || "", "Contact Phone": s.contactPhone || "", "Address": s.address || "" };
                });

                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Students_Export");
                XLSX.writeFile(wb, `Student_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showLoader(false); showToast("Export successful!");
            } catch (err) { console.error("Export Error:", err); showLoader(false); showToast("Failed to export students", "error"); }
        }

        // --- SCALABLE PAGINATION LOGIC (STUDENTS) ---
        function resetPagination() { lastStudentDoc = null; hasMoreStudents = true; localState.students = []; }

        async function fetchStudents(isLoadMore = false) {
            if (!hasMoreStudents && isLoadMore) return;
            const btn = $('btn-load-more');
            if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Loading...';
            if (!isLoadMore) $('student-list').innerHTML = '<div class="p-8 text-center text-muted"><i class="fas fa-spinner fa-spin mr-2"></i> Fetching records from database...</div>';

            let q = db.collection('students').where('institutionId', '==', currentUser.id);

            const filterClass = $('s-filter-class') ? $('s-filter-class').value : '';
            if (filterClass) q = q.where('classId', '==', filterClass);

            const searchVal = $('s-search') ? $('s-search').value.trim() : '';
            if (searchVal) q = q.where('admissionNo', '==', searchVal);

            q = q.limit(50);
            if (isLoadMore && lastStudentDoc) q = q.startAfter(lastStudentDoc);

            try {
                const snap = await q.get();
                if (snap.empty) {
                    hasMoreStudents = false;
                    if (!isLoadMore) $('student-list').innerHTML = '<div class="p-8 text-center text-muted">No students found.</div>';
                } else {
                    lastStudentDoc = snap.docs[snap.docs.length - 1];
                    const newStus = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    if (isLoadMore) localState.students = [...localState.students, ...newStus];
                    else localState.students = newStus;
                    
                    if (snap.docs.length < 50) hasMoreStudents = false;
                    renderStudentListHTML();
                }
            } catch (e) { console.error("Pagination Error:", e); showToast("Failed to load students", "error"); }
            
            if (btn) {
                if (hasMoreStudents && !searchVal) {
                    btn.innerHTML = '<i class="fas fa-chevron-down mr-2"></i> Load More Students';
                    btn.classList.remove('hidden');
                } else { btn.classList.add('hidden'); }
            }
        }

        function renderStudentListHTML() {
            const isTeacher = currentUser.role === 'teacher';
            const list = localState.students;
            const container = $('student-list');
            
            if(list.length === 0) { container.innerHTML = '<div class="p-8 text-center text-muted">No students found.</div>'; return; }

            container.innerHTML = `<div class="divide-y divide-theme/50">${list.map(s => {
                const cls = localState.classes.find(c=>c.id===s.classId)?.name || 'N/A';
                return `<div class="p-3 md:p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center hover:bg-slate-800/10 transition group px-4 md:px-6 gap-3 border-b border-theme/50 last:border-0 w-full">
                    <div class="flex items-center gap-3 md:gap-4 w-full sm:w-auto">
                        ${!isTeacher ? `<input type="checkbox" class="stu-check rounded bg-dark border-theme shrink-0" value="${s.id}" onchange="updateBulkState()">` : ''}
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-sm text-main truncate">${s.name}</p>
                            <p class="text-[10px] text-muted font-mono mt-0.5 truncate">${s.admissionNo}  <span class="text-indigo-400">${cls}</span> ${s.parentName ? `<span class="opacity-70 hidden md:inline">  <i class="fas fa-user-friends mx-1"></i>${s.parentName}</span>` : ''}</p>
                        </div>
                    </div>
                    ${!isTeacher ? `
                    <div class="flex gap-2 w-full sm:w-auto justify-end sm:opacity-50 group-hover:opacity-100 transition shrink-0 mt-2 sm:mt-0">
                        <button onclick="editItem('students','${s.id}')" class="px-4 py-2 md:p-2 text-xs md:text-sm text-muted hover:text-blue-500 bg-dark md:bg-transparent rounded-lg transition border border-theme md:border-transparent md:hover:border-theme shadow-sm md:shadow-none flex-1 sm:flex-none text-center"><i class="fas fa-edit mr-2 md:mr-0"></i><span class="md:hidden">Edit</span></button>
                        <button onclick="deleteItem('students','${s.id}')" class="px-4 py-2 md:p-2 text-xs md:text-sm text-red-500 hover:bg-red-500 hover:text-white bg-dark md:bg-transparent rounded-lg transition border border-theme md:border-transparent md:hover:border-red-500 shadow-sm md:shadow-none flex-1 sm:flex-none text-center"><i class="fas fa-trash mr-2 md:mr-0"></i><span class="md:hidden">Delete</span></button>
                    </div>` : ''}
                </div>`;
            }).join('')}</div>`;
            updateBulkState();
        }

        async function downloadMarksTemplate(cid, eid) {
            showLoader(true);
            const snap = await db.collection('students').where('classId', '==', cid).get();
            const classStus = snap.docs.map(d => ({id: d.id, ...d.data()}));
            const subjects = localState.subjects.filter(s => s.classId === cid);
            showLoader(false);

            if(classStus.length === 0 || subjects.length === 0) return showToast("No students or subjects found in this class", "error");
            
            const data = classStus.map(s => { const row = { "Admission No": s.admissionNo, "Name": s.name }; subjects.forEach(sub => row[sub.name] = ""); row["Attendance Days"] = ""; return row; });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Marks_Entry"); const clsName = localState.classes.find(c=>c.id===cid)?.name || "Class"; XLSX.writeFile(wb, `Marks_Template_${clsName}.xlsx`);
        }

        async function loadResultGrid() {
            const eid=$('pub-exam').value, cid=$('pub-class').value;
            if(!eid||!cid) return showToast("Select Exam & Class","error");
            showLoader(true);
            const stuSnap = await db.collection('students').where('classId', '==', cid).get();
            let stus = stuSnap.docs.map(d => ({id: d.id, ...d.data()}));
            if(!stus.length) { showLoader(false); return showToast("No students in this class", "error"); }

            const resSnap = await db.collection('results').where('examId', '==', eid).get();
            localState.results = resSnap.docs.map(d => ({id: d.id, ...d.data()}));
            const res = localState.results;
            const subs = localState.subjects.filter(s => s.classId === cid); 
            
            const otherStudents = localState.students.filter(s => s.classId !== cid);
            localState.students = [...otherStudents, ...stus]; 

            const existingRes = res.find(r => r.totalAttendance); 
            const totalAtt = existingRes ? existingRes.totalAttendance : '';
            showLoader(false);

            if(currentSort.key) {
                const mapped = stus.map(s => { const r = res.find(x => x.studentId === s.id); return { ...s, total: r?.total||0, att: Number(r?.attendance)||0, rank: r?.rank||9999 }; });
                mapped.sort((a, b) => {
                    let valA, valB;
                    if(currentSort.key === 'rank') { if(a.total !== b.total) return currentSort.order === 'asc' ? b.total - a.total : a.total - b.total; return b.att - a.att; }
                    if(currentSort.key === 'name') { valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); }
                    if(currentSort.key === 'attendance') { valA = a.att; valB = b.att; }
                    if(valA < valB) return currentSort.order === 'asc' ? -1 : 1; if(valA > valB) return currentSort.order === 'asc' ? 1 : -1; return 0;
                });
                stus = mapped;
            }
            
            let html=`
                <div class="glass-panel p-5 md:p-6 mb-6 rounded-2xl flex flex-col gap-5 shadow-xl relative z-20 border-t-4 border-indigo-500 w-full">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 w-full">
                        <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                            <button onclick="downloadMarksTemplate('${cid}', '${eid}')" class="btn-secondary text-xs flex-1 sm:flex-none"><i class="fas fa-download mr-1"></i> Template</button>
                            <div class="flex items-center justify-between gap-3 bg-dark/60 px-4 py-2 rounded-lg border border-theme w-full sm:w-auto mt-1 sm:mt-0">
                                <span class="font-bold text-muted uppercase text-[10px] tracking-wider">Attendance Days</span>
                                <input type="number" id="total-att" class="bg-transparent border-none text-yellow-400 font-bold w-16 text-right focus:outline-none p-0 m-0 text-sm" value="${totalAtt}" placeholder="0">
                            </div>
                        </div>
                        <button onclick="saveResults('${eid}','${cid}')" class="btn-primary px-8 py-3 rounded-xl shadow-lg shadow-indigo-500/20 w-full lg:w-auto flex items-center justify-center gap-2 shrink-0 text-sm">
                            <i class="fas fa-save text-lg"></i> Save Results
                        </button>
                    </div>
                    <div class="flex items-center justify-between sm:justify-start sm:gap-10 border-t border-theme pt-4">
                        <div class="stat-group"><span class="stat-label">Students</span><span class="stat-val text-xl">${stus.length}</span></div>
                        <div class="stat-group"><span class="stat-label">Class Avg</span><span class="stat-val text-xl" id="live-avg">--</span></div>
                        <div class="stat-group"><span class="stat-label">Pass Rate</span><span class="stat-val text-xl text-emerald-500" id="live-pass">--%</span></div>
                    </div>
                </div>
                <div class="me-container shadow-2xl relative z-10 w-full overflow-hidden"><div class="overflow-x-auto pb-6 w-full"><table class="w-full text-left me-table min-w-full"><thead><tr>
                    <th class="sticky left-0 bg-panel z-20 w-48 border-r border-theme" onclick="sortGrid('name')">Student Identity <i class="fas fa-sort ml-1"></i></th>
                    ${subs.map(s=>`<th class="text-center min-w-[100px] border-l border-theme">${s.name}<br><span class="text-[9px] opacity-50 font-normal">Max: ${s.fullMarks}</span></th>`).join('')}
                    <th class="text-center w-24 border-l border-theme text-yellow-500" onclick="sortGrid('attendance')">Attendance <i class="fas fa-sort ml-1"></i></th>
                    <th class="text-center w-24 border-l border-theme" onclick="sortGrid('rank')">Rank <i class="fas fa-sort ml-1"></i></th>
                    <th class="text-center w-24 border-l border-theme">Preview</th>
                </tr></thead><tbody class="divide-y divide-theme">`;
            
            stus.forEach(s => {
                const r = res.find(x => x.studentId === s.id); const marks = r ? r.subjectMarks : {}; const att = r ? (r.attendance || '') : '';
                let isFail = false; subs.forEach(sub => { if((marks[sub.id]||0) < sub.passMarks && marks[sub.id] !== '') isFail = true; });
                const statusClass = r ? (isFail ? 'rs-fail' : 'rs-pass') : 'rs-neutral';

                html += `<tr class="hover:bg-black/10 transition relative group"><td data-label="Student" class="p-3 sticky left-0 bg-panel z-10 border-r border-theme"><div class="row-status ${statusClass}" id="rs-${s.id}"></div><div class="pl-4 font-bold text-sm text-main">${s.name}</div><div class="pl-4 text-[10px] text-muted font-mono">${s.admissionNo}</div></td>
                ${subs.map(sub=> {
                    const val = marks[sub.id] !== undefined ? marks[sub.id] : '';
                    const isFailMark = val !== '' && Number(val) < sub.passMarks;
                    return `<td data-label="${sub.name}" class="border-l border-theme p-1"><div class="mark-wrapper"><input type="number" class="mark-input ${isFailMark ? 'fail-mark' : ''}" data-sid="${s.id}" data-sub="${sub.id}" data-max="${sub.fullMarks}" data-pass="${sub.passMarks}" value="${val}" oninput="calcRow(this)"></div></td>`;
                }).join('')}
                <td data-label="Attendance" class="p-1 border-l border-theme"><div class="mark-wrapper"><input type="number" class="mark-input att-input" data-sid="${s.id}" data-type="att" value="${att}"></div></td>
                <td data-label="Rank" class="border-l border-theme text-center font-bold text-main">${r?.rank || '-'}</td>
                <td data-label="Preview" class="border-l border-theme text-center p-1"><button onclick="previewTranscript('${s.id}')" class="p-2 text-muted hover:text-main transition w-full py-2 bg-dark rounded"><i class="fas fa-eye"></i> View</button></td></tr>`;
            });
            
            html += `</tbody></table></div></div>`;
            $('result-grid-container').innerHTML = html; updateLiveStats();
        }

        function sortGrid(key) { currentSort = { key, order: currentSort.key === key && currentSort.order === 'asc' ? 'desc' : 'asc' }; loadResultGrid(true); }

        function calcRow(inp) {
            let val = Number(inp.value); 
            const max = Number(inp.dataset.max); 
            const pass = Number(inp.dataset.pass); 
            const sid = inp.dataset.sid;

            if(val > max) { val = max; inp.value = max; showToast(`Max marks allowed is ${max}`, "error"); }
            if(val < 0) { val = 0; inp.value = 0; }
            if(val < pass && inp.value !== '') inp.classList.add('fail-mark'); else inp.classList.remove('fail-mark');
            
            let isFail = false; let hasMarks = false;
            document.querySelectorAll(`.mark-input[data-sid="${sid}"]:not([data-type="att"])`).forEach(i => { 
                if(i.value !== '') { hasMarks = true; if(Number(i.value) < Number(i.dataset.pass)) isFail = true; }
            });
            $(`rs-${sid}`).className = `row-status ${hasMarks ? (isFail ? 'rs-fail' : 'rs-pass') : 'rs-neutral'}`;
            updateLiveStats();
        }

        function updateLiveStats() {
            const rows = document.querySelectorAll('tbody tr'); if(rows.length === 0) return;
            let totalScore = 0, passCount = 0, count = 0;
            rows.forEach(r => {
                const statusDiv = r.querySelector('.row-status');
                if(statusDiv) {
                    if(statusDiv.classList.contains('rs-pass')) passCount++;
                    let rowTotal = 0; r.querySelectorAll('.mark-input:not(.att-input)').forEach(i => rowTotal += Number(i.value||0));
                    totalScore += rowTotal; count++;
                }
            });
            if(count > 0 && $('live-avg')) { $('live-avg').innerText = (totalScore / count).toFixed(1); $('live-pass').innerText = Math.round((passCount / count) * 100) + '%'; }
        }

        async function saveResults(eid, cid) {
            showLoader(true);
            const batch = db.batch();
            const markInputs = document.querySelectorAll('.mark-input:not(.att-input)');
            const attInputs = document.querySelectorAll('.att-input');
            const totalAtt = $('total-att').value;
            const map = {}; 
            
            markInputs.forEach(i => { if(!map[i.dataset.sid]) map[i.dataset.sid] = { marks: {}, att: '' }; map[i.dataset.sid].marks[i.dataset.sub] = i.value === '' ? '' : Number(i.value); });
            attInputs.forEach(i => { if(!map[i.dataset.sid]) map[i.dataset.sid] = { marks: {}, att: '' }; map[i.dataset.sid].att = i.value === '' ? '' : Number(i.value); });

            let rankingData = [];
            Object.keys(map).forEach(sid => {
                const marks = map[sid].marks;
                const total = Object.values(marks).reduce((a,b)=>a+Number(b), 0);
                rankingData.push({ sid, total, att: Number(map[sid].att) });
            });
            rankingData.sort((a,b) => { if(b.total !== a.total) return b.total - a.total; return b.att - a.att; });

            let rank = 1;
            for(let i=0; i<rankingData.length; i++) {
                if(i > 0 && rankingData[i].total === rankingData[i-1].total && rankingData[i].att === rankingData[i-1].att) rankingData[i].rank = rankingData[i-1].rank;
                else rankingData[i].rank = i + 1;
            }

            const oldRes = localState.results.filter(r => r.examId === eid && localState.students.find(s=>s.id === r.studentId)?.classId === cid);
            oldRes.forEach(r => batch.delete(db.collection('results').doc(r.id)));

            rankingData.forEach(d => {
                const docRef = db.collection('results').doc();
                batch.set(docRef, { institutionId: currentUser.id, examId: eid, studentId: d.sid, subjectMarks: map[d.sid].marks, total: d.total, attendance: map[d.sid].att, totalAttendance: totalAtt, rank: d.rank });
            });

            await batch.commit(); await loadResultGrid(); showLoader(false); showToast("Results Saved & Ranked");
        }

        function previewTranscript(sid) {
            const s = localState.students.find(x => x.id === sid); const eid = $('pub-exam').value; const exam = localState.exams.find(e => e.id === eid);
            const inputs = document.querySelectorAll(`input[data-sid="${sid}"]:not(.att-input)`); const attVal = document.querySelector(`input.att-input[data-sid="${sid}"]`)?.value || '0'; const totalAtt = $('total-att').value || '-';
            const gradeScale = currentUser.customGradeScale || DEFAULT_SCALES[currentUser.gradeScale || 'standard'];
            let legendStr = getGradeLegend(gradeScale);
            
            let total = 0, maxTotal = 0, rows = '';
            inputs.forEach(inp => {
                const sub = localState.subjects.find(sb => sb.id === inp.dataset.sub);
                const score = inp.value === '' ? '-' : Number(inp.value);
                let grade = '-';
                if(score !== '-') { total += score; maxTotal += sub.fullMarks; grade = getGrade((score / sub.fullMarks) * 100, gradeScale); }
                rows += `<tr><td class="text-left font-bold pl-6 text-slate-800">${sub.name}</td><td>${sub.fullMarks}</td><td>${sub.passMarks}</td><td class="font-bold ${score !== '-' ? (score < sub.passMarks ? 'text-red-600' : 'text-emerald-600') : 'text-slate-900'}">${score}</td><td class="font-bold text-slate-700">${grade}</td></tr>`;
            });

            const finalPct = maxTotal > 0 ? ((total / maxTotal) * 100).toFixed(1) : 0;
            let status = 'PASS'; inputs.forEach(inp => { const pass = Number(inp.dataset.pass); if(inp.value !== '' && Number(inp.value) < pass) status = 'FAIL'; });
            const clsName = status === 'PASS' ? 'pass' : 'fail';
            let finalGrade = getGrade(finalPct, gradeScale);
            if(status === 'FAIL') finalGrade = 'F';
            
            let appreciation = "Good effort."; let motivation = "Keep working hard!";
            if(status === 'FAIL') { appreciation = "You faced some challenges this term."; motivation = "Every setback is a setup for a comeback. We believe in you!"; } 
            else if(finalPct >= 90) { appreciation = "Exceptional performance! Outstanding mastery."; motivation = "Your dedication is inspiring. Keep setting the bar high!"; }
            else if(finalPct >= 80) { appreciation = "Excellent work! Strong grasp of concepts."; motivation = "Consistency is key. Continue this momentum."; }
            else if(finalPct >= 60) { appreciation = "Very Good. Steady progress made."; motivation = "Believe in your potential, you can do even more."; }

            $('marksheet-modal').classList.remove('hidden');
            $('mk-content-layer').innerHTML = `
                <div class="text-center mb-6"><div class="inline-block mb-2 p-1 border border-slate-200 rounded-full">
                <div class="w-20 h-20 rounded-full flex items-center justify-center overflow-hidden bg-slate-100">
                    ${currentUser.profileImage ? `<img src="${currentUser.profileImage}" crossorigin="anonymous" class="max-w-full max-h-full object-contain">` : `<i class="fas fa-university text-4xl text-slate-300"></i>`}
                </div>
                </div><h1 class="text-3xl font-black uppercase mk-header-font text-slate-900 mb-1 text-center">${currentUser.name}</h1><p class="text-xs text-slate-500 uppercase tracking-widest font-bold text-center">${currentUser.address || ''}</p><div class="mt-4 border-b border-slate-900 w-1/3 mx-auto"></div><p class="mt-1 text-sm font-serif italic text-slate-700 text-center">Official Statement of Marks</p></div>
                <div class="info-grid flex justify-between mb-4 text-sm"><div class="flex flex-col gap-2"><div class="info-row"><span class="info-label font-bold text-slate-500 w-24 inline-block">Candidate</span><span class="info-val font-bold text-slate-900">${s.name}</span></div><div class="info-row"><span class="info-label font-bold text-slate-500 w-24 inline-block">ID No</span><span id="mk-adm" class="info-val font-mono font-bold text-slate-900">${s.admissionNo}</span></div><div class="info-row"><span class="info-label font-bold text-slate-500 w-24 inline-block">D.O.B</span><span class="info-val font-bold text-slate-900">${s.dob || 'N/A'}</span></div></div><div class="flex flex-col gap-2 text-right"><div class="info-row"><span class="info-label font-bold text-slate-500 mr-2">Class</span><span class="info-val font-bold text-slate-900">${localState.classes.find(c=>c.id===s.classId)?.name}</span></div><div class="info-row"><span class="info-label font-bold text-slate-500 mr-2">Exam</span><span class="info-val font-bold text-slate-900">${exam.name} <span class="text-xs text-slate-500 ml-1">[${exam.academicYear||''}]</span></span></div><div class="info-row"><span class="info-label font-bold text-slate-500 mr-2">Date</span><span class="info-val font-bold text-slate-900">${new Date().toLocaleDateString()}</span></div></div></div>
                <table class="mk-table mb-auto"><thead><tr><th class="text-left pl-6">Subject</th><th width="15%">Max Marks</th><th width="15%">Pass Marks</th><th width="15%">Obtained</th><th width="15%">Grade</th></tr></thead><tbody>${rows}</tbody><tfoot><tr class="bg-slate-100 text-slate-900"><td class="text-left font-black pl-6 text-sm uppercase tracking-widest">Grand Total</td><td colspan="2" class="text-center font-bold text-slate-500 text-xs uppercase">${numToWords(total)}</td><td class="text-center text-lg font-bold text-slate-900 py-3" colspan="2">${total} / ${maxTotal}</td></tr></tfoot></table>
                ${legendStr ? `<div class="mt-4 mb-2 text-[8px] text-slate-500 font-mono text-center border-t border-slate-200 pt-2"><strong>GRADING LEGEND:</strong> ${legendStr}</div>` : ''}
                <div class="feedback-section flex justify-between mt-4 gap-4"><div class="appreciation-box w-2/3 p-3 bg-slate-50 rounded border border-slate-200"><h4 class="font-bold text-xs uppercase text-slate-400 mb-1"><i class="fas fa-quote-left mr-2 opacity-50"></i>Insight</h4><p class="appr-text text-sm font-serif italic text-slate-700">"${appreciation}"</p><p class="motiv-text text-xs text-slate-500 mt-1">"${motivation}"</p></div><div class="stats-box w-1/3 p-3 bg-slate-100 rounded border border-slate-200 text-right"><div class="stat-row mb-1"><span class="stat-label text-xs text-slate-500 mr-2">Percentage</span><span class="stat-val font-bold text-slate-900">${finalPct}%</span></div><div class="stat-row mb-1"><span class="stat-label text-xs text-slate-500 mr-2">Overall Grade</span><span class="stat-val text-sm font-bold text-slate-900">${finalGrade}</span></div><div class="stat-row mb-1"><span class="stat-label text-xs text-slate-500 mr-2">Attendance</span><span class="stat-val text-sm font-bold text-slate-900">${attVal}/${totalAtt}</span></div><div class="stat-row mt-2"><span class="stat-label text-xs text-slate-500 mr-2">Result Status</span><div class="stamp-status ${clsName}">${status}</div></div></div></div>
                <div class="doc-footer border-t-2 border-slate-900 pt-6 mt-4 flex justify-between items-end"><div class="text-[8px] text-slate-500 font-mono w-2/3 leading-tight">This document is securely processed and digitally generated by <span class="dynamic-brand-name">easyresults</span> Cloud Systems.<br>Valid academic record. No physical signature required for web verification.</div><div class="principal-box text-center"><div class="h-16 flex items-end justify-center mb-1">${currentUser.signatureImage ? `<img src="${currentUser.signatureImage}" crossorigin="anonymous" class="max-h-full max-w-full object-contain filter grayscale contrast-125">` : '<div class="h-8 border-b border-black w-32 mx-auto"></div>'}</div><div class="border-t-2 border-slate-900 w-32 mx-auto mb-1"></div><p class="text-[9px] font-bold uppercase tracking-widest text-slate-900">Principal Signature</p></div></div>
            `;
            
            if(currentUser.profileImage) $('mk-watermark').src = currentUser.profileImage;
            
            const ctr = document.getElementById('mk-printable');
            ctr.style.display = 'block'; 
            if(window.innerWidth < 800) {
                const padding = 16; const availableWidth = window.innerWidth - (padding * 2);
                const scale = availableWidth / 794; 
                ctr.style.transform = `scale(${scale})`; ctr.style.transformOrigin = 'top left'; ctr.style.marginLeft = `${padding}px`; 
                const heightLoss = 1122 * (1 - scale); ctr.style.marginBottom = `-${heightLoss}px`; 
            } else {
                ctr.style.display = 'inline-block'; ctr.style.margin = '0 auto'; ctr.style.transform = 'scale(0.8)'; ctr.style.transformOrigin = 'top center';
                const heightLoss = 1122 * (1 - 0.8); ctr.style.marginBottom = `-${heightLoss}px`;
            }
        }
        
        function downloadPDF() {
            showLoader(true);
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('mk-printable'); 
            const originalTransform = element.style.transform;
            const originalMargin = element.style.marginBottom;
            const originalMarginLeft = element.style.marginLeft;
            element.style.transform = 'scale(1)';
            element.style.marginBottom = '0';
            element.style.marginLeft = '0';
            
            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                element.style.transform = originalTransform; 
                element.style.marginBottom = originalMargin;
                element.style.marginLeft = originalMarginLeft;
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                const admNo = document.getElementById('mk-adm').innerText || 'Student';
                pdf.save(`${admNo}_Transcript.pdf`);
                showLoader(false);
            }).catch(err => {
                element.style.transform = originalTransform; 
                element.style.marginBottom = originalMargin;
                element.style.marginLeft = originalMarginLeft;
                console.error(err);
                showLoader(false);
                showToast("PDF generation failed", "error");
            });
        }

        async function saveSettings() {
            showLoader(true);
            draftGradeScale.sort((a, b) => b.m - a.m);
            const data = {
                name: $('set-name').value, tagline: $('set-tag').value, aboutText: $('set-about').value,
                contactEmail: $('set-email').value, contactPhone: $('set-phone').value, address: $('set-addr').value,
                themeColor: $('set-color').value, theme: $('set-theme').value, 
                gradeScale: $('set-grade-scale').value, customGradeScale: draftGradeScale
            };
            if (currentUser.hasFullAccess === true) {
                data.profileImage = formatImageUrl($('set-logo').value.trim());
                data.signatureImage = formatImageUrl($('set-sig').value.trim());
            }
            await db.collection('institutions').doc(currentUser.id).update(data);
            currentUser = { ...currentUser, ...data }; 
            localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
            applyTheme(currentUser); 
            if (currentUser.profileImage) {
                $('sidebar-logo').src = currentUser.profileImage;
                $('sidebar-logo').classList.remove('hidden');
                $('sidebar-icon').classList.add('hidden');
                if($('mobile-header-logo-admin')) {
                    $('mobile-header-logo-admin').src = currentUser.profileImage;
                    $('mobile-header-logo-admin').classList.remove('hidden');
                    $('mobile-header-icon-admin').classList.add('hidden');
                }
            } else {
                $('sidebar-logo').classList.add('hidden');
                $('sidebar-icon').classList.remove('hidden');
                if($('mobile-header-logo-admin')) {
                    $('mobile-header-logo-admin').classList.add('hidden');
                    $('mobile-header-icon-admin').classList.remove('hidden');
                }
            }
            showLoader(false); 
            showToast("Profile Updated");
        }
    </script>
</body>
</html>