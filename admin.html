<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console | GradeWise</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
        /* --- DYNAMIC THEME SYSTEM --- */
        :root {
            --bg-dark: #020617;
            --bg-panel: rgba(15, 23, 42, 0.85);
            --bg-input: rgba(30, 41, 59, 0.6);
            --primary: #6366f1; 
            --primary-glow: rgba(99, 102, 241, 0.5);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.08);
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            background-image: radial-gradient(at 0% 0%, var(--primary-glow) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        .glass-panel { 
            background: var(--bg-panel); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: background 0.5s ease, border-color 0.5s ease;
        }
        
        .input-field { 
            background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main);
            padding: 12px 16px; border-radius: 10px; width: 100%; outline: none; 
            transition: all 0.2s ease; font-size: 0.95rem;
        }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
        
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #4338ca);
            color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600;
            transition: all 0.2s; box-shadow: 0 4px 15px -3px var(--primary-glow);
            display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
        }
        .btn-primary:hover { transform: translateY(-1px); filter: brightness(1.1); }
        
        .btn-secondary {
            background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border);
            padding: 10px 16px; border-radius: 10px; font-weight: 600; font-size: 0.85rem;
            transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }

        .nav-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 6px;
            border-radius: 10px; color: var(--text-muted); transition: all 0.2s; cursor: pointer; font-weight: 500;
            border: 1px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .nav-item.active { background: var(--primary-glow); color: white; border-color: var(--primary); }

        /* Result Grid */
        .me-container {
            border: 1px solid var(--border); border-radius: 16px;
            background: var(--bg-panel); backdrop-filter: blur(20px);
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .me-table th { 
            text-transform: uppercase; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.05em; color: var(--text-muted);
            padding: 1.25rem 1rem; border-bottom: 2px solid var(--border); background: rgba(0,0,0,0.3);
            cursor: pointer; user-select: none;
        }
        .me-table th:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .me-table td { border-bottom: 1px solid var(--border); padding: 0.75rem 1rem; position: relative; vertical-align: middle; }
        
        .mark-wrapper { position: relative; display: flex; align-items: center; justify-content: center; }
        .mark-input {
            background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border); 
            color: var(--text-main); text-align: center; width: 64px; padding: 10px 4px; border-radius: 8px; 
            outline: none; font-weight: 600; font-family: 'Inter', sans-serif; transition: all 0.2s;
        }
        .mark-input:focus { background: var(--primary-glow); border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); transform: translateY(-1px); }
        .mark-input.fail-mark { color: #fca5a5; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
        
        /* New Attendance Input Styles */
        .att-input { border-color: rgba(251, 191, 36, 0.4); color: #fbbf24; }
        .att-input:focus { border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2); }

        .command-bar {
            position: fixed; bottom: 2.5rem; left: 50%; transform: translateX(-50%);
            background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(20px);
            border: 1px solid var(--border); padding: 0.8rem 2rem;
            border-radius: 24px; display: flex; items-center; gap: 3rem;
            box-shadow: 0 25px 60px -10px rgba(0,0,0,0.6); z-index: 50;
            width: auto; min-width: 600px; justify-content: space-between;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translate(-50%, 150%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        .fade-in { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(15px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        #global-loader { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        /* A4 Styles */
        .a4-container { width: 210mm; height: 297mm; background: #fff; color: #1e293b; font-family: 'Inter', sans-serif; transform: scale(0.65); transform-origin: top center; margin: 0 auto; display: flex; flex-direction: column; }
        .transcript-frame { border: 8px solid #1e293b; outline: 2px solid #94a3b8; outline-offset: -12px; height: 100%; margin: 8mm; position: relative; display: flex; flex-direction: column; background: #fff; }
        .transcript-inner { padding: 8mm 12mm; height: 100%; display: flex; flex-direction: column; background-image: radial-gradient(#f1f5f9 1px, transparent 1px); background-size: 25px 25px; }
        .mk-header-font { font-family: 'Cinzel', serif; }
        .mk-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        .mk-table th { background: #f8fafc; padding: 10px; border-top: 2px solid #1e293b; border-bottom: 2px solid #1e293b; }
        .mk-table td { border-bottom: 1px solid #e2e8f0; padding: 10px; text-align: center; }
    </style>
</head>
<body class="overflow-hidden h-screen flex text-sm selection:bg-indigo-500/30">

    <div id="global-loader" class="fixed inset-0 flex flex-col items-center justify-center text-white">
        <div class="spinner mb-4"></div>
        <p class="text-sm font-bold tracking-widest animate-pulse">SYNCING CLOUD...</p>
    </div>

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <section id="view-login" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] hidden">
        <div class="glass-panel p-10 rounded-3xl shadow-2xl w-full max-w-sm relative z-10 border-t border-white/10">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-6 border border-white/10 shadow-lg text-white">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight text-white">Admin Console</h1>
                <p class="text-slate-400 text-xs uppercase tracking-widest mt-2">Secure Access</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-5">
                <div><label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Email</label><input type="email" id="login-email" class="input-field" required></div>
                <div><label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Password</label><input type="password" id="login-pass" class="input-field" required></div>
                <button id="btn-login" class="w-full btn-primary py-3.5 rounded-xl shadow-lg mt-2">Access Dashboard</button>
            </form>
            <div class="mt-8 text-center text-xs text-slate-500"><a href="home.html" class="hover:text-white transition">Return to Portal</a></div>
        </div>
    </section>

    <div id="view-dashboard" class="hidden w-full h-full flex bg-[#0f172a]">
        <aside id="main-sidebar" class="sidebar w-72 bg-[#020617] border-r border-slate-800 flex flex-col flex-shrink-0 z-40 relative transition-colors duration-500">
            <div class="p-8 border-b border-slate-800/50 flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white bg-slate-800 font-bold border border-slate-700 overflow-hidden shadow-lg relative" style="background-color: var(--primary);">
                    <img id="sidebar-logo" class="w-full h-full object-cover hidden">
                    <i id="sidebar-icon" class="fas fa-university text-lg"></i>
                </div>
                <div class="overflow-hidden">
                    <h2 class="font-bold text-white text-sm leading-tight truncate w-32" id="sidebar-inst-name">Loading...</h2>
                    <span class="text-[10px] text-slate-500 font-mono uppercase tracking-wider font-bold">Administrator</span>
                </div>
            </div>
            <nav class="flex-1 p-5 space-y-2 overflow-y-auto">
                <div class="text-[10px] font-extrabold text-slate-600 uppercase tracking-widest mb-2 px-3">Management</div>
                <div onclick="renderTab('overview')" class="nav-item active"><i class="fas fa-chart-line w-5 text-center"></i> Overview</div>
                <div onclick="renderTab('classes')" class="nav-item"><i class="fas fa-chalkboard w-5 text-center"></i> Classes</div>
                <div onclick="renderTab('students')" class="nav-item"><i class="fas fa-user-graduate w-5 text-center"></i> Students</div>
                <div class="text-[10px] font-extrabold text-slate-600 uppercase tracking-widest mb-2 px-3 mt-6">Academics</div>
                <div onclick="renderTab('exams')" class="nav-item"><i class="fas fa-clock w-5 text-center"></i> Exams</div>
                <div onclick="renderTab('publish')" class="nav-item"><i class="fas fa-edit w-5 text-center"></i> Result Entry</div>
                <div class="text-[10px] font-extrabold text-slate-600 uppercase tracking-widest mb-2 px-3 mt-6">System</div>
                <div onclick="renderTab('settings')" class="nav-item"><i class="fas fa-cog w-5 text-center"></i> School Profile</div>
            </nav>
            <div class="p-5 border-t border-slate-800/50 bg-[#020617]">
                <button onclick="logout()" class="w-full py-2.5 text-red-400 text-xs font-bold hover:bg-red-500/10 rounded-xl transition border border-red-500/10 hover:border-red-500/20 flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 relative">
            <header class="h-20 border-b border-slate-800 bg-[#020617]/80 backdrop-blur-md flex items-center justify-between px-6 sticky top-0 z-30 transition-colors duration-500">
                <div class="flex items-center gap-4">
                    <div><h2 id="page-title" class="text-lg font-bold text-white tracking-tight">Overview</h2></div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="viewPublicPage()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg border border-slate-700 transition text-xs font-bold flex items-center gap-2"><span>Homepage</span> <i class="fas fa-external-link-alt"></i></button>
                </div>
            </header>
            <div id="content-area" class="flex-1 overflow-y-auto p-6 md:p-10 pb-32 scroll-smooth"></div>
        </main>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 z-[70] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 fade-in overflow-y-auto">
        <div class="glass-panel w-full max-w-4xl rounded-2xl overflow-hidden relative border-t border-white/10 my-auto" id="modal-content-wrapper">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                <h3 class="text-lg font-bold text-white" id="modal-title">Edit</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="modal-body" class="p-6 bg-[#020617] max-h-[80vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDluJn6c-9vr3jJUEIl3FJ2l4HD4W1M2k",
            authDomain: "gradewise-app.firebaseapp.com",
            projectId: "gradewise-app",
            storageBucket: "gradewise-app.firebasestorage.app",
            messagingSenderId: "938150156100",
            appId: "1:938150156100:web:219cfacbf0452ddfe2e911"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        const SESSION_KEY = 'GradeWise_admin_session';
        let currentUser = null;
        let activeChart = null;
        let localState = { students: [], classes: [], exams: [], results: [], subjects: [] };
        
        // Sorting State
        let currentSort = { key: 'rank', order: 'asc' };

        const $ = id => document.getElementById(id);
        const showLoader = (show) => $('global-loader').classList.toggle('hidden', !show);
        
        function showToast(msg, type='success') {
            const el = document.createElement('div');
            el.className = `px-5 py-4 rounded-xl shadow-2xl border backdrop-blur-md text-sm font-bold flex items-center gap-3 fade-in ${type==='success'?'bg-emerald-500/10 border-emerald-500/30 text-emerald-400':'bg-red-500/10 border-red-500/30 text-red-400'}`;
            el.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-circle'} text-lg"></i> ${msg}`;
            $('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        async function uploadImage(path, dataUrl) {
            if(!dataUrl || !dataUrl.startsWith('data:')) return null;
            const ref = storage.ref().child(path);
            await ref.putString(dataUrl, 'data_url');
            return await ref.getDownloadURL();
        }

        // --- AUTH & INIT ---
        async function handleLogin(e) {
            e.preventDefault();
            const btn = $('btn-login'); btn.innerText = "Checking...";
            const email = $('login-email').value;
            const pass = $('login-pass').value;

            try {
                const snap = await db.collection('institutions').where('email', '==', email).where('pass', '==', pass).get();
                if(!snap.empty) {
                    const doc = snap.docs[0];
                    if(doc.data().isActive === false) return showToast("Account Suspended", "error");
                    currentUser = { id: doc.id, ...doc.data() };
                    localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                    initDashboard();
                } else { showToast("Invalid Credentials", "error"); btn.innerText = "Access Dashboard"; }
            } catch(e) { console.error(e); showToast("Network Error", "error"); btn.innerText = "Access Dashboard"; }
        }

        function checkSession() {
            const session = localStorage.getItem(SESSION_KEY);
            if(session) { currentUser = JSON.parse(session); initDashboard(); } 
            else { $('global-loader').classList.add('hidden'); $('view-login').classList.remove('hidden'); }
        }

        async function initDashboard() {
            $('view-login').classList.add('hidden');
            $('global-loader').classList.remove('hidden');
            $('view-dashboard').classList.remove('hidden');
            $('sidebar-inst-name').innerText = currentUser.name;
            if(currentUser.profileImage) { $('sidebar-logo').src = currentUser.profileImage; $('sidebar-logo').classList.remove('hidden'); $('sidebar-icon').classList.add('hidden'); }
            
            // Apply theme
            const root = document.documentElement;
            root.style.setProperty('--primary', currentUser.themeColor || '#6366f1');
            root.style.setProperty('--primary-glow', (currentUser.themeColor || '#6366f1') + '40');
            
            await refreshData();
            $('global-loader').classList.add('hidden');
            renderTab('overview');
        }

        function logout() { localStorage.removeItem(SESSION_KEY); location.reload(); }
        function viewPublicPage() { window.open(`home.html?id=${currentUser.id}`, '_blank'); }
        window.onload = checkSession;

        async function refreshData() {
            try {
                const [c, s, e, r, sub] = await Promise.all([
                    db.collection('classes').where('institutionId', '==', currentUser.id).get(),
                    db.collection('students').where('institutionId', '==', currentUser.id).get(),
                    db.collection('exams').where('institutionId', '==', currentUser.id).get(),
                    db.collection('results').where('institutionId', '==', currentUser.id).get(),
                    db.collection('subjects').where('institutionId', '==', currentUser.id).get()
                ]);
                
                localState.classes = c.docs.map(d => ({id: d.id, ...d.data()}));
                localState.students = s.docs.map(d => ({id: d.id, ...d.data()}));
                localState.exams = e.docs.map(d => ({id: d.id, ...d.data()}));
                localState.results = r.docs.map(d => ({id: d.id, ...d.data()}));
                localState.subjects = sub.docs.map(d => ({id: d.id, ...d.data()}));
            } catch(e) { console.error("Sync Error", e); }
        }

        // --- DASHBOARD TABS ---
        async function renderTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.getAttribute('onclick').includes(tab)));
            const content = $('content-area');
            const title = $('page-title');
            
            if(tab === 'overview') {
                title.innerText = 'Overview';
                await refreshData();
                const sCount = localState.students.length;
                const cCount = localState.classes.length;
                const eCount = localState.exams.length;

                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in">
                        <div class="glass-panel p-6 rounded-2xl border-l-4 border-l-blue-500"><p class="text-xs font-bold uppercase" style="color:var(--text-muted)">Total Students</p><h3 class="text-3xl font-bold mt-2" style="color:var(--text-main)">${sCount}</h3></div>
                        <div class="glass-panel p-6 rounded-2xl border-l-4 border-l-purple-500"><p class="text-xs font-bold uppercase" style="color:var(--text-muted)">Active Classes</p><h3 class="text-3xl font-bold mt-2" style="color:var(--text-main)">${cCount}</h3></div>
                        <div class="glass-panel p-6 rounded-2xl border-l-4 border-l-emerald-500"><p class="text-xs font-bold uppercase" style="color:var(--text-muted)">Exams Conducted</p><h3 class="text-3xl font-bold mt-2" style="color:var(--text-main)">${eCount}</h3></div>
                    </div>
                    <div class="glass-panel p-8 rounded-2xl fade-in"><h4 class="text-lg font-bold mb-6" style="color:var(--text-main)">Student Distribution</h4><div class="h-64"><canvas id="mainChart"></canvas></div></div>`;
                
                if(activeChart) activeChart.destroy();
                const ctx = $('mainChart').getContext('2d');
                activeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: localState.classes.map(c=>c.name),
                        datasets: [{ label: 'Students', data: localState.classes.map(c=>localState.students.filter(s=>s.classId===c.id).length), backgroundColor: currentUser.themeColor || '#6366f1', borderRadius: 6 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#1f2937' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } }
                });
            }

            if(tab === 'classes') {
                title.innerText = 'Classes & Subjects';
                await refreshData();
                content.innerHTML = `
                    <div class="glass-panel p-6 rounded-2xl mb-6 fade-in flex gap-4">
                        <input id="new-class" class="input-field" placeholder="Class Name (e.g. Grade 10-A)">
                        <button onclick="addClass()" class="btn-primary flex-shrink-0">Add Class</button>
                    </div>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in">${localState.classes.map(c => `
                        <div class="glass-panel p-6 rounded-2xl group relative hover:border-slate-500 transition">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-bold" style="color:var(--text-main)">${c.name}</h3>
                                <div class="flex gap-2">
                                    <button onclick="editItem('classes','${c.id}','${c.name}')" class="text-slate-600 hover:text-blue-400 transition"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteItem('classes','${c.id}')" class="text-slate-600 hover:text-red-400 transition"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <button onclick="manageSubjects('${c.id}')" class="w-full py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs font-bold text-indigo-300 transition border border-white/5">Manage ${localState.subjects.filter(s=>s.classId===c.id).length} Subjects</button>
                        </div>`).join('') || '<div class="text-slate-500 p-4 col-span-3 text-center">No classes found. Add one above.</div>'}
                    </div>`;
            }

            if(tab === 'students') {
                title.innerText = 'Student Directory';
                await refreshData();
                const opts = localState.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                
                content.innerHTML = `
                    <div class="grid lg:grid-cols-3 gap-6 mb-6 fade-in h-[calc(100vh-180px)]">
                        <div class="glass-panel p-6 rounded-2xl lg:col-span-1 h-fit">
                            <h4 class="font-bold mb-4 border-b border-slate-700 pb-2" style="color:var(--text-main)">Register Student</h4>
                            <div class="space-y-3">
                                <input id="s-name" class="input-field" placeholder="Full Name">
                                <input id="s-adm" class="input-field" placeholder="Admission No (Unique)">
                                <div class="grid grid-cols-2 gap-2"><input id="s-dob" type="date" class="input-field text-slate-400"><select id="s-class" class="input-field text-slate-400"><option value="">Class...</option>${opts}</select></div>
                                <button onclick="addStudent()" class="w-full btn-primary mt-2">Register</button>
                            </div>
                            <div class="mt-6 pt-6 border-t border-slate-700">
                                <h4 class="font-bold mb-2 text-xs uppercase tracking-wider" style="color:var(--text-main)">Bulk Actions</h4>
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <button onclick="downloadStudentTemplate()" class="flex-1 btn-secondary text-xs"><i class="fas fa-download mr-1"></i> Template</button>
                                        <button onclick="exportStudents()" class="flex-1 btn-secondary text-xs"><i class="fas fa-file-export mr-1"></i> Export</button>
                                    </div>
                                    <div class="relative">
                                        <input type="file" id="s-file" class="hidden" accept=".xlsx,.csv" onchange="bulkImport()">
                                        <button onclick="$('s-file').click()" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"><i class="fas fa-file-import"></i> Upload Excel Data</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel rounded-2xl lg:col-span-2 overflow-hidden flex flex-col h-full">
                            <div class="p-4 border-b border-slate-700 bg-slate-900/50 flex flex-wrap gap-2 items-center">
                                <input id="s-search" onkeyup="renderStudentList()" class="input-field bg-transparent border-0 flex-1 min-w-[150px]" placeholder="Search students...">
                                <select id="s-filter-class" onchange="renderStudentList()" class="input-field w-auto text-xs py-2"><option value="">All Classes</option>${opts}</select>
                            </div>
                            <div class="flex-1 overflow-y-auto p-0" id="student-list"></div>
                        </div>
                    </div>`;
                renderStudentList();
            }

            if(tab === 'exams') {
                title.innerText = 'Exams';
                await refreshData();
                content.innerHTML = `
                    <div class="glass-panel p-6 rounded-2xl mb-6 fade-in flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Exam Title</label>
                            <input id="new-exam" class="input-field" placeholder="e.g. Finals 2024">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Result Publish Date</label>
                            <input id="new-exam-date" type="datetime-local" class="input-field text-slate-400" style="color-scheme: dark;">
                        </div>
                        <button onclick="addExam()" class="btn-primary flex-shrink-0 h-[46px]">Create Exam</button>
                    </div>
                    <div class="space-y-3 fade-in">${localState.exams.map(e=> {
                        const d = e.publishDate ? new Date(e.publishDate).toLocaleString() : 'Immediate';
                        return `
                        <div class="glass-panel p-4 rounded-xl flex justify-between items-center group">
                            <div>
                                <span class="font-bold block" style="color:var(--text-main)">${e.name}</span>
                                <span class="text-[10px] text-slate-500 font-mono"><i class="fas fa-clock mr-1"></i> Published: ${d}</span>
                            </div>
                            <div class="flex gap-2 opacity-50 group-hover:opacity-100 transition">
                                <button onclick="editItem('exams','${e.id}')" class="text-slate-600 hover:text-blue-400 p-2"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteItem('exams','${e.id}')" class="text-slate-600 hover:text-red-400 p-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                    }).join('')}
                    </div>`;
            }

            if(tab === 'publish') {
                title.innerText = 'Result Entry';
                await refreshData();
                content.innerHTML = `
                    <div class="glass-panel p-8 rounded-2xl max-w-3xl mx-auto fade-in text-center border-t-4 border-indigo-500">
                        <h3 class="text-2xl font-bold mb-2" style="color:var(--text-main)">Publish Results</h3>
                        <p class="text-slate-400 mb-6">Select exam and class to enter marks. Existing marks will be loaded automatically.</p>
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <select id="pub-exam" class="input-field cursor-pointer"><option value="">Select Exam</option>${localState.exams.map(e=>`<option value="${e.id}">${e.name}</option>`)}</select>
                            <select id="pub-class" class="input-field cursor-pointer"><option value="">Select Class</option>${localState.classes.map(c=>`<option value="${c.id}">${c.name}</option>`)}</select>
                        </div>
                        <button onclick="loadResultGrid()" class="btn-primary px-10 py-3 rounded-xl shadow-lg">Load Console</button>
                    </div>
                    <div id="result-grid-container" class="mt-8 fade-in pb-32"></div>`;
            }

            if(tab === 'settings') {
                title.innerText = 'School Profile';
                const i = currentUser;
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto fade-in space-y-6 pb-20">
                        <div class="glass-panel p-8 rounded-2xl">
                            <h4 class="font-bold border-b border-slate-700 pb-4 mb-6" style="color:var(--text-main)">Identity & Branding</h4>
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">School Name</label><input id="set-name" class="input-field mt-1" value="${i.name}"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Tagline</label><input id="set-tag" class="input-field mt-1" value="${i.tagline||''}"></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500 uppercase">About</label><textarea id="set-about" class="input-field mt-1" rows="3">${i.aboutText||''}</textarea></div>
                            </div>
                        </div>
                        <div class="glass-panel p-8 rounded-2xl">
                            <h4 class="font-bold border-b border-slate-700 pb-4 mb-6" style="color:var(--text-main)">Contact & Assets</h4>
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Email</label><input id="set-email" class="input-field mt-1" value="${i.contactEmail||''}"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Phone</label><input id="set-phone" class="input-field mt-1" value="${i.contactPhone||''}"></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500 uppercase">Address</label><input id="set-addr" class="input-field mt-1" value="${i.address||''}"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">School Logo</label><input type="file" id="set-logo" class="input-field mt-1 text-xs"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Principal Signature</label><input type="file" id="set-sig" class="input-field mt-1 text-xs"></div>
                            </div>
                        </div>
                        <button onclick="saveSettings()" class="w-full btn-primary py-4 rounded-xl shadow-lg">Save & Update Profile</button>
                    </div>`;
            }
        }

        // --- UNIVERSAL EDIT FUNCTION ---
        function editItem(type, id) {
            $('modal-overlay').classList.remove('hidden');
            $('modal-title').innerText = `Edit ${type.slice(0, -1)}`; 
            
            // Find item in local cache
            const item = type === 'subjects' 
                ? localState.subjects.find(s => s.id === id) 
                : localState[type].find(x => x.id === id);
                
            let html = '';
            
            if(type === 'classes') {
                html = `<div class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Name</label><input id="edit-val-name" class="input-field" value="${item.name}"></div>
                    <button onclick="saveEdit('${type}', '${id}')" class="w-full btn-primary">Save Changes</button>
                </div>`;
            } 
            else if(type === 'students') {
                const classOpts = localState.classes.map(c => `<option value="${c.id}" ${c.id === item.classId ? 'selected' : ''}>${c.name}</option>`).join('');
                html = `<div class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Full Name</label><input id="edit-val-name" class="input-field" value="${item.name}"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Admission No</label><input id="edit-val-adm" class="input-field" value="${item.admissionNo}"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Date of Birth</label><input id="edit-val-dob" type="date" class="input-field text-slate-400" value="${item.dob || ''}"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Class</label><select id="edit-val-class" class="input-field text-slate-400">${classOpts}</select></div>
                    <button onclick="saveEdit('${type}', '${id}')" class="w-full btn-primary">Save Changes</button>
                </div>`;
            }
            else if(type === 'exams') {
                // Convert UTC date to local datetime-local string
                let dateVal = '';
                if(item.publishDate) {
                    const d = new Date(item.publishDate);
                    dateVal = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                }
                html = `<div class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Exam Name</label><input id="edit-val-name" class="input-field" value="${item.name}"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Publish Date</label><input id="edit-val-date" type="datetime-local" class="input-field text-slate-400" style="color-scheme: dark;" value="${dateVal}"></div>
                    <button onclick="saveEdit('${type}', '${id}')" class="w-full btn-primary">Save Changes</button>
                </div>`;
            }
            else if(type === 'subjects') {
                html = `<div class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Subject Name</label><input id="edit-sub-name" class="input-field" value="${item.name}"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Total Marks</label><input id="edit-sub-full" type="number" class="input-field" value="${item.fullMarks}"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Pass Marks</label><input id="edit-sub-pass" type="number" class="input-field" value="${item.passMarks}"></div>
                    </div>
                    <input type="hidden" id="edit-sub-cid" value="${item.classId}">
                    <button onclick="saveEdit('subjects', '${id}')" class="w-full btn-primary">Update Subject</button>
                </div>`;
            }
            
            $('modal-body').innerHTML = html;
        }

        async function saveEdit(type, id) {
            showLoader(true);
            let updateData = {};
            
            if(type === 'classes') {
                updateData = { name: $('edit-val-name').value };
            } 
            else if(type === 'students') {
                updateData = { 
                    name: $('edit-val-name').value, 
                    admissionNo: $('edit-val-adm').value,
                    dob: $('edit-val-dob').value,
                    classId: $('edit-val-class').value
                };
            }
            else if(type === 'exams') {
                const d = $('edit-val-date').value;
                updateData = { 
                    name: $('edit-val-name').value, 
                    publishDate: d ? new Date(d).toISOString() : new Date().toISOString()
                };
            }
            else if(type === 'subjects') {
                updateData = { 
                    name: $('edit-sub-name').value, 
                    fullMarks: Number($('edit-sub-full').value), 
                    passMarks: Number($('edit-sub-pass').value) 
                };
            }
            
            await db.collection(type).doc(id).update(updateData);
            await refreshData();
            
            $('modal-overlay').classList.add('hidden');
            showLoader(false);
            showToast("Updated Successfully");
            
            if(type === 'subjects') {
                manageSubjects($('edit-sub-cid').value);
            } else {
                await renderTab(type);
            }
        }
        
        function closeModal() { $('modal-overlay').classList.add('hidden'); }

        // --- CRUD ACTIONS ---
        async function addClass() {
            const n = $('new-class').value;
            if(n) {
                showLoader(true);
                await db.collection('classes').add({ institutionId: currentUser.id, name: n, createdAt: new Date().toISOString() });
                await renderTab('classes');
                showLoader(false);
                showToast("Class Added");
            }
        }

        async function addStudent() {
            const n=$('s-name').value, a=$('s-adm').value, c=$('s-class').value, d=$('s-dob').value;
            if(n&&a&&c) {
                showLoader(true);
                if(localState.students.some(s => s.admissionNo === a)) { showLoader(false); return showToast("Admission No exists", "error"); }
                await db.collection('students').add({ institutionId: currentUser.id, name: n, admissionNo: a, classId: c, dob: d, password: a });
                await renderTab('students');
                showLoader(false);
                showToast("Student Added");
            }
        }

        async function addExam() {
            const n = $('new-exam').value;
            const d = $('new-exam-date').value;
            if(n) {
                showLoader(true);
                const pubDate = d ? new Date(d).toISOString() : new Date().toISOString();
                await db.collection('exams').add({ institutionId: currentUser.id, name: n, publishDate: pubDate });
                await renderTab('exams');
                showLoader(false);
                showToast("Exam Created");
            }
        }

        async function deleteItem(col, id) {
            if(confirm("Permanently Delete?")) {
                showLoader(true);
                await db.collection(col).doc(id).delete();
                const activeTab = document.querySelector('.nav-item.active').getAttribute('onclick').match(/'(.*)'/)[1];
                await renderTab(activeTab);
                showLoader(false);
                showToast("Deleted");
            }
        }

        // --- STUDENT LIST ---
        function renderStudentList() {
            let list = [...localState.students];
            const filterClass = $('s-filter-class') ? $('s-filter-class').value : '';
            const search = $('s-search') ? $('s-search').value.toLowerCase() : '';
            
            if (filterClass) list = list.filter(s => s.classId === filterClass);
            if (search) list = list.filter(s => s.name.toLowerCase().includes(search) || s.admissionNo.toLowerCase().includes(search));

            const container = $('student-list');
            if(list.length === 0) { container.innerHTML = '<div class="p-8 text-center text-slate-500">No students found.</div>'; return; }

            container.innerHTML = `<div class="divide-y divide-slate-800">${list.map(s => {
                const cls = localState.classes.find(c=>c.id===s.classId)?.name || 'N/A';
                return `<div class="p-4 flex justify-between items-center hover:bg-slate-800/50 transition px-6">
                    <div><p class="font-bold text-sm" style="color:var(--text-main)">${s.name}</p><p class="text-[10px] text-slate-500 font-mono">${s.admissionNo} â€¢ <span class="text-indigo-400">${cls}</span></p></div>
                    <div class="flex gap-2">
                        <button onclick="editItem('students','${s.id}')" class="p-2 text-slate-600 hover:text-blue-400 bg-slate-900/50 rounded transition"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteItem('students','${s.id}')" class="p-2 text-red-400 bg-red-900/20 rounded hover:bg-red-500 hover:text-white transition"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('')}</div>`;
        }

        // --- SUBJECTS ---
        function manageSubjects(cid) { 
            $('modal-overlay').classList.remove('hidden'); 
            $('modal-title').innerText = "Manage Subjects"; 
            renderSubjectModal(cid); 
        }
        
        function renderSubjectModal(cid, defFull='100', defPass='33') {
            const subs = localState.subjects.filter(s => s.classId === cid);
            $('modal-body').innerHTML = `
                <div class="flex flex-col gap-3 mb-4 p-4 bg-slate-900/50 rounded-xl border border-slate-700/50">
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-3"><label class="text-[10px] uppercase font-bold text-slate-500">Subject Name</label><input id="sb-n" class="input-field text-xs" placeholder="e.g. Mathematics"></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-500">Total Marks</label><input id="sb-f" type="number" class="input-field text-xs" value="${defFull}"></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-500">Pass Mark</label><input id="sb-p" type="number" class="input-field text-xs" value="${defPass}"></div>
                        <div class="flex items-end"><button onclick="addSub('${cid}')" class="w-full btn-primary text-xs py-2.5 rounded-lg"><i class="fas fa-plus"></i> Add</button></div>
                    </div>
                </div>
                <div class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    ${subs.map(s => `<div class="flex justify-between bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-xs items-center group">
                        <span class="font-bold text-slate-300">${s.name} <span class="text-slate-500 font-normal ml-1">(Max: ${s.fullMarks})</span></span>
                        <div class="flex gap-2">
                            <button onclick="editItem('subjects', '${s.id}')" class="text-slate-500 hover:text-blue-400"><i class="fas fa-edit"></i></button>
                            <button onclick="delSub('${s.id}','${cid}')" class="text-slate-500 hover:text-red-400"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('')}
                </div>`;
        }

        async function addSub(cid) {
            const n=$('sb-n').value, f=$('sb-f').value, p=$('sb-p').value;
            if(n) {
                await db.collection('subjects').add({ institutionId: currentUser.id, classId: cid, name: n, fullMarks: Number(f), passMarks: Number(p) });
                await refreshData(); 
                renderSubjectModal(cid, f, p);
            }
        }
        
        async function delSub(sid, cid) {
            await db.collection('subjects').doc(sid).delete();
            await refreshData(); renderSubjectModal(cid);
        }

        // --- BULK EXCEL & GRID & EXPORT ---
        function downloadStudentTemplate() { 
            const ws = XLSX.utils.aoa_to_sheet([["Full Name", "Admission No", "Date of Birth (YYYY-MM-DD)", "Class Name"]]); 
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Students"); 
            XLSX.writeFile(wb, "Student_Template.xlsx"); 
        }

        function exportStudents() {
            const data = localState.students.map(s => {
                const cls = localState.classes.find(c => c.id === s.classId)?.name || 'N/A';
                return { "Full Name": s.name, "Admission No": s.admissionNo, "Class": cls, "Date of Birth": s.dob || '' };
            });
            if(data.length === 0) return showToast("No students to export", "error");
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Student_Directory");
            XLSX.writeFile(wb, "Student_Directory.xlsx");
        }

        function bulkImport() {
            const f=$('s-file').files[0]; if(!f) return;
            const r=new FileReader();
            r.onload = async (e) => {
                showLoader(true);
                const w = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const data = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                const batch = db.batch(); let count = 0;
                for (const row of data) {
                    const name = row['Full Name'] || row['Name']; const adm = row['Admission No'] || row['AdmissionNo']; const clsName = row['Class Name'] || row['Class'];
                    if(name && adm && clsName) {
                        let classId = localState.classes.find(c => c.name.toLowerCase() === clsName.toLowerCase())?.id;
                        if(!classId) { const clsRef = db.collection('classes').doc(); batch.set(clsRef, { institutionId: currentUser.id, name: clsName }); classId = clsRef.id; }
                        const ref = db.collection('students').doc();
                        batch.set(ref, { institutionId: currentUser.id, name: String(name), admissionNo: String(adm), classId: classId, password: String(adm) });
                        count++;
                    }
                }
                await batch.commit(); await renderTab('students'); showLoader(false); showToast(`Imported ${count} records`);
            };
            r.readAsArrayBuffer(f);
        }

        function importMarks() {
            const f=$('mark-file').files[0]; if(!f) return;
            const r=new FileReader();
            r.onload = async (e) => {
                showLoader(true);
                const w = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const data = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                
                // Map uploaded data to input fields
                data.forEach(row => {
                    const adm = row['Admission No'] || row['AdmissionNo'];
                    const att = row['Attendance'];
                    const s = localState.students.find(stu => stu.admissionNo == adm);
                    if(s) {
                        if(att) { const attInput = document.querySelector(`.att-input[data-sid="${s.id}"]`); if(attInput) attInput.value = att; }
                        localState.subjects.forEach(sub => {
                            const val = row[sub.name];
                            if(val !== undefined) {
                                const inp = document.querySelector(`.mark-input:not(.att-input)[data-sid="${s.id}"][data-sub="${sub.id}"]`);
                                if(inp) { inp.value = val; updateMarkStatus(inp); }
                            }
                        });
                    }
                });
                showLoader(false); showToast("Data mapped! Click Publish to save.");
            };
            r.readAsArrayBuffer(f);
        }

        function exportResults() {
            const eid=$('pub-exam').value, cid=$('pub-class').value;
            const stus = localState.students.filter(s => s.classId === cid);
            const subs = localState.subjects.filter(s => s.classId === cid);
            const res = localState.results.filter(r => r.examId === eid);
            
            const data = stus.map(s => {
                const r = res.find(x => x.studentId === s.id);
                const marks = r ? r.subjectMarks : {};
                const row = { "Admission No": s.admissionNo, "Name": s.name, "Attendance": r?.attendance || '' };
                subs.forEach(sub => row[sub.name] = marks[sub.id] || '');
                row["Total"] = r?.total || 0;
                row["Rank"] = r?.rank || '-';
                return row;
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Results");
            XLSX.writeFile(wb, "Result_Sheet.xlsx");
        }

        function sortGrid(key) {
            currentSort = { key, order: currentSort.key === key && currentSort.order === 'asc' ? 'desc' : 'asc' };
            loadResultGrid(true); // reload with sort
        }

        function loadResultGrid(isSort=false) {
            const eid=$('pub-exam').value, cid=$('pub-class').value;
            if(!eid||!cid) return showToast("Select Exam & Class","error");
            
            let stus = localState.students.filter(s => s.classId === cid);
            const subs = localState.subjects.filter(s => s.classId === cid);
            const res = localState.results.filter(r => r.examId === eid);
            const existingRes = res.find(r => r.totalAttendance);
            const totalAtt = existingRes ? existingRes.totalAttendance : '';

            // --- SORTING LOGIC ---
            if(currentSort.key) {
                // Map students to a temporary object with rank/marks for sorting
                const mapped = stus.map(s => {
                    const r = res.find(x => x.studentId === s.id);
                    return { ...s, total: r?.total||0, att: Number(r?.attendance)||0, rank: r?.rank||9999 };
                });

                mapped.sort((a, b) => {
                    let valA, valB;
                    if(currentSort.key === 'rank') { 
                        // Special logic for rank: Low rank number is better (1 is better than 2)
                        // But if we sort by Total Marks (desc), it mimics rank
                        if(a.total !== b.total) return currentSort.order === 'asc' ? b.total - a.total : a.total - b.total;
                        return b.att - a.att; // Tie breaker: Attendance
                    }
                    if(currentSort.key === 'name') { valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); }
                    if(currentSort.key === 'attendance') { valA = a.att; valB = b.att; }
                    
                    if(valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                    if(valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                    return 0;
                });
                stus = mapped; // Reorder stus based on sort
            }

            if(!stus.length) return showToast("No students in class", "error");
            
            let html=`
                <div class="glass-panel p-4 mb-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="$('mark-file').click()" class="btn-secondary text-xs"><i class="fas fa-file-upload mr-2"></i> Import Marks (Excel)</button>
                        <button onclick="exportResults()" class="btn-secondary text-xs"><i class="fas fa-file-download mr-2"></i> Export Result Sheet</button>
                        <input type="file" id="mark-file" hidden onchange="importMarks()" accept=".xlsx,.csv">
                    </div>
                    <div class="flex items-center gap-2">
                        <h4 class="font-bold text-slate-400 uppercase text-xs">Total Working Days</h4>
                        <input type="number" id="total-att" class="input-field w-32 text-center" value="${totalAtt}" placeholder="e.g. 200">
                    </div>
                </div>
                <div class="me-container shadow-2xl relative"><div class="overflow-x-auto"><table class="w-full text-left me-table"><thead><tr>
                    <th class="sticky left-0 bg-[#0f172a] z-20 w-48 border-r border-slate-800" onclick="sortGrid('name')">Student Identity <i class="fas fa-sort ml-1"></i></th>
                    <th class="text-center w-24 border-r border-slate-800/50" onclick="sortGrid('attendance')">Attendance <i class="fas fa-sort ml-1"></i></th>
                    ${subs.map(s=>`<th class="text-center min-w-[100px] border-l border-slate-800/50">${s.name}<br><span class="text-[9px] opacity-50 font-normal">Max: ${s.fullMarks}</span></th>`).join('')}
                    <th class="text-center w-24 border-l border-slate-800" onclick="sortGrid('rank')">Rank <i class="fas fa-sort ml-1"></i></th>
                    <th class="text-center w-24 border-l border-slate-800">Preview</th>
                </tr></thead><tbody class="divide-y divide-slate-800/50">`;
            
            stus.forEach(s => {
                const r = res.find(x => x.studentId === s.id);
                const marks = r ? r.subjectMarks : {};
                const att = r ? (r.attendance || '') : '';
                
                html += `<tr class="hover:bg-slate-800/30 transition relative group"><td class="p-3 sticky left-0 bg-[#0f172a] z-10 border-r border-slate-800"><div class="pl-3 font-bold text-sm" style="color:var(--text-main)">${s.name}</div><div class="pl-3 text-[10px] text-slate-500 font-mono">${s.admissionNo}</div></td>
                <td class="p-1 border-r border-slate-800/50"><div class="mark-wrapper"><input type="number" class="mark-input att-input" data-sid="${s.id}" data-type="att" value="${att}"></div></td>
                ${subs.map(sub=> {
                    const val = marks[sub.id] || '';
                    const isFail = val !== '' && Number(val) < sub.passMarks;
                    return `<td class="border-l border-slate-800/50 p-1"><div class="mark-wrapper"><input type="number" class="mark-input ${isFail ? 'fail-mark' : ''}" data-sid="${s.id}" data-sub="${sub.id}" data-pass="${sub.passMarks}" value="${val}" oninput="updateMarkStatus(this)"></div></td>`;
                }).join('')}
                <td class="border-l border-slate-800/50 text-center font-bold text-white">${r?.rank || '-'}</td>
                <td class="border-l border-slate-800/50 text-center p-1"><button onclick="previewTranscript('${s.id}')" class="p-2 text-slate-500 hover:text-white transition"><i class="fas fa-eye"></i></button></td></tr>`;
            });
            
            html += `</tbody></table></div></div><div class="command-bar"><button onclick="saveResults('${eid}','${cid}')" class="btn-primary px-8 py-3 rounded-xl shadow-lg flex items-center gap-2"><i class="fas fa-rocket"></i> Publish Results</button></div>`;
            $('result-grid-container').innerHTML = html;
        }

        function updateMarkStatus(input) {
            const val = input.value;
            const pass = Number(input.dataset.pass);
            if(val !== '' && Number(val) < pass) input.classList.add('fail-mark');
            else input.classList.remove('fail-mark');
        }

        async function saveResults(eid, cid) {
            showLoader(true);
            const batch = db.batch();
            const markInputs = document.querySelectorAll('.mark-input:not(.att-input)');
            const attInputs = document.querySelectorAll('.att-input');
            const totalAtt = $('total-att').value;
            const map = {}; 
            
            markInputs.forEach(i => { if(!map[i.dataset.sid]) map[i.dataset.sid] = { marks: {}, att: '' }; map[i.dataset.sid].marks[i.dataset.sub] = Number(i.value); });
            attInputs.forEach(i => { if(!map[i.dataset.sid]) map[i.dataset.sid] = { marks: {}, att: '' }; map[i.dataset.sid].att = Number(i.value); });

            // Prepare for Ranking
            let rankingData = [];
            Object.keys(map).forEach(sid => {
                const marks = map[sid].marks;
                const total = Object.values(marks).reduce((a,b)=>a+b, 0);
                rankingData.push({ sid, total, att: map[sid].att });
            });

            // Sort: Total Desc, then Att Desc
            rankingData.sort((a,b) => {
                if(b.total !== a.total) return b.total - a.total;
                return b.att - a.att;
            });

            // Assign Rank with Tie Logic
            let rank = 1;
            for(let i=0; i<rankingData.length; i++) {
                if(i > 0 && rankingData[i].total === rankingData[i-1].total && rankingData[i].att === rankingData[i-1].att) {
                    rankingData[i].rank = rankingData[i-1].rank;
                } else {
                    rankingData[i].rank = i + 1;
                }
            }

            // Save
            const oldRes = localState.results.filter(r => r.examId === eid && localState.students.find(s=>s.id === r.studentId)?.classId === cid);
            oldRes.forEach(r => batch.delete(db.collection('results').doc(r.id)));

            rankingData.forEach(d => {
                const docRef = db.collection('results').doc();
                batch.set(docRef, { 
                    institutionId: currentUser.id, examId: eid, studentId: d.sid, 
                    subjectMarks: map[d.sid].marks, total: d.total, 
                    attendance: d.att, totalAttendance: totalAtt, rank: d.rank
                });
            });

            await batch.commit();
            await refreshData(); // Refresh local cache to get new ranks
            loadResultGrid(); // Re-render grid to show ranks
            showLoader(false);
            showToast("Results Published & Ranked");
        }

        function previewTranscript(sid) {
            const s = localState.students.find(x => x.id === sid);
            const eid = $('pub-exam').value;
            const inputs = document.querySelectorAll(`input[data-sid="${sid}"]:not(.att-input)`);
            const attVal = document.querySelector(`input.att-input[data-sid="${sid}"]`)?.value || '0';
            const totalAtt = $('total-att').value || '-';
            
            let total = 0, maxTotal = 0, rows = '';
            inputs.forEach(inp => {
                const sub = localState.subjects.find(sb => sb.id === inp.dataset.sub);
                const score = Number(inp.value)||0;
                total += score; maxTotal += sub.fullMarks;
                rows += `<tr><td>${sub.name}</td><td>${sub.fullMarks}</td><td>${sub.passMarks}</td><td>${score}</td></tr>`;
            });

            $('modal-overlay').classList.remove('hidden');
            $('modal-body').innerHTML = `
                <div class="a4-container"><div class="transcript-frame"><div class="transcript-inner">
                    <div class="text-center mb-6"><h1 class="text-3xl font-black uppercase mk-header-font text-slate-900 mb-1 text-center">${currentUser.name}</h1><p class="text-xs text-slate-500 uppercase tracking-widest font-bold text-center">Official Transcript</p></div>
                    <div class="info-grid mb-4"><div class="flex flex-col gap-2"><div><span class="font-bold">Student:</span> ${s.name}</div><div><span class="font-bold">ID:</span> ${s.admissionNo}</div></div></div>
                    <table class="mk-table mt-4"><thead><tr><th>Subject</th><th>Max</th><th>Pass</th><th>Score</th></tr></thead><tbody>${rows}</tbody><tfoot><tr class="bg-slate-100"><td colspan="3" class="text-right font-bold pr-4">Total</td><td class="text-center font-bold">${total} / ${maxTotal}</td></tr></tfoot></table>
                    <div class="mt-8 text-sm font-bold border-t pt-4">Attendance: ${attVal} / ${totalAtt} Days</div>
                </div></div></div>
                <div class="text-center mt-4"><button onclick="closeModal()" class="btn-primary">Close</button></div>`;
        }
        
        async function saveSettings() {
            showLoader(true);
            const data = {
                name: $('set-name').value, tagline: $('set-tag').value, aboutText: $('set-about').value,
                contactEmail: $('set-email').value, contactPhone: $('set-phone').value, address: $('set-addr').value
            };
            const logo = $('set-logo').files[0];
            const sig = $('set-sig').files[0];
            if(logo) data.profileImage = await uploadImage(`logos/${currentUser.id}_logo`, await readFile(logo));
            if(sig) data.signatureImage = await uploadImage(`logos/${currentUser.id}_sig`, await readFile(sig));
            await db.collection('institutions').doc(currentUser.id).update(data);
            localStorage.setItem(SESSION_KEY, JSON.stringify({ ...currentUser, ...data }));
            showLoader(false); showToast("Profile Updated");
        }

        const readFile = (file) => new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(file); });
    </script>
</body>
</html>